<div class="create-company-page">
    <div class="card-header" style="margin-top: 2rem; border-bottom: none; padding-bottom: 0;">
        <h1>Create New Package</h1>
        <p style="color: var(--gray-500); margin-top: 0.5rem;">Group products together into a professional bundle.</p>
    </div>

    <div class="card" style="margin-top: 2rem;">
        <form id="packageForm" action="/admin/packages/create" method="POST" enctype="multipart/form-data">
            <div class="form-grid">
                <!-- Basic Info -->
                <div class="form-group" style="grid-column: span 1;">
                    <label for="name">Package Name <span style="color: var(--danger);">*</span></label>
                    <input type="text" id="name" name="name" required placeholder="e.g., ICU Complete Setup">
                </div>

                <div class="form-group" style="grid-column: span 1;">
                    <label for="bundle_label">Hero Label (e.g. Premium Medical Bundle)</label>
                    <input type="text" id="bundle_label" name="bundle_label" placeholder="Premium Medical Bundle">
                </div>

                <div class="form-group" style="grid-column: span 2;">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="3"
                        placeholder="Enter package description..."></textarea>
                </div>

                <div class="form-group" style="grid-column: span 2;">
                    <label for="main_image">Package Main Image (Optional)</label>
                    <div class="image-upload-dropzone" id="dropzone">
                        <input type="file" id="main_image" accept="image/*" hidden>
                        <input type="hidden" name="main_image_path" id="main_image_path">
                        <div class="dropzone-content" id="dropzone-content">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop your image here or <span>click to browse</span></p>
                            <span class="upload-hint">Supports: JPG, PNG, WebP (Max 5MB)</span>
                        </div>
                        <div id="image-preview-container" class="image-preview-container hidden">
                            <img id="image-preview" src="" alt="Preview">
                            <button type="button" class="remove-image-btn" id="remove-image-btn" title="Remove image">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div id="uploadProgressContainer" class="upload-progress-container"
                            style="display: none; position: absolute; bottom: 10px; left: 10px; right: 10px;">
                            <div class="upload-progress-bar"></div>
                            <span class="upload-status-text">Uploading...</span>
                        </div>
                    </div>
                    <p style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.5rem;">This image will replace
                        the dynamic product stack in the hero section.</p>
                </div>

                <!-- Key Specs / Highlights -->
                <div class="form-group" style="grid-column: span 2;">
                    <label>Key Specs / Highlights</label>
                    <div id="specsContainer">
                        <!-- Dynamic specs will be added here -->
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="addSpecRow()"
                        style="margin-top: 0.5rem;">
                        <i class="fas fa-plus"></i> Add Highlight Point
                    </button>
                    <p style="font-size: 0.8rem; color: var(--gray-500); margin-top: 0.5rem;">These appear as bullet
                        points with icons in the hero section.</p>
                </div>

                <!-- Product Selection & Ordering -->
                <div class="form-group" style="grid-column: span 2;">
                    <label>Select & Order Products</label>
                    <div class="product-selector-wrapper"
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 0.5rem;">
                        <!-- Available Products -->
                        <div>
                            <div style="position: relative; margin-bottom: 0.5rem;">
                                <i class="fas fa-search"
                                    style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--gray-400);"></i>
                                <input type="text" id="productSearch" placeholder="Search available products..."
                                    style="padding-left: 2.5rem; margin-bottom: 0;">
                            </div>
                            <div id="availableProducts"
                                style="max-height: 400px; overflow-y: auto; border: 1px solid var(--gray-300); border-radius: 8px; padding: 1rem; background: var(--gray-50);">
                                <% products.forEach(product=> { %>
                                    <div class="product-selection-item" data-id="<%= product.id %>"
                                        data-model="<%= product.model.toLowerCase() %>"
                                        data-code="<%= product.code.toLowerCase() %>"
                                        onclick="toggleProductSelection(this)"
                                        style="display: flex; align-items: center; margin-bottom: 0.5rem; background: white; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--gray-200); cursor: pointer; transition: all 0.2s;">
                                        <i class="fas fa-plus" style="margin-right: 1rem; color: var(--gray-300);"></i>
                                        <div style="display: flex; flex-direction: column;">
                                            <span style="font-weight: 600; color: var(--blue-darkest);">
                                                <%= product.model %>
                                            </span>
                                            <span style="font-size: 0.75rem; color: var(--gray-500);">
                                                <%= product.code %>
                                            </span>
                                        </div>
                                    </div>
                                    <% }) %>
                            </div>
                        </div>

                        <!-- Chosen Products (Ordered) -->
                        <div>
                            <label style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 0.5rem;">Selected
                                Products (Drag to reorder)</label>
                            <div id="chosenProducts"
                                style="min-height: 400px; border: 2px dashed var(--gray-300); border-radius: 8px; padding: 1rem; background: var(--white);">
                                <!-- Selected products appear here -->
                            </div>
                            <p style="font-size: 0.75rem; color: var(--gray-400); margin-top: 0.5rem;">The order here
                                defines how they appear in the hero and listing.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div
                style="margin-top: 2.5rem; display: flex; gap: 1rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i class="fas fa-save" style="margin-right: 0.5rem;"></i> Create Package
                </button>
                <a href="/admin/packages" class="btn btn-outline"
                    style="text-decoration: none; text-align: center;">Cancel</a>
            </div>
        </form>
    </div>
</div>

<style>
    .spec-row {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        align-items: center;
        background: var(--gray-50);
        padding: 0.5rem;
        border-radius: 8px;
        border: 1px solid var(--gray-200);
    }

    .icon-picker-wrapper {
        position: relative;
        width: 60px;
    }

    .icon-display {
        width: 100%;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border: 1px solid var(--gray-300);
        border-radius: 6px;
        cursor: pointer;
        font-size: 1.2rem;
        color: var(--blue-medium);
    }

    .icon-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 100;
        background: white;
        border: 1px solid var(--gray-300);
        border-radius: 8px;
        box-shadow: var(--shadow-lg);
        padding: 0.5rem;
        width: 250px;
    }

    .icon-dropdown.show {
        display: block;
    }

    .icon-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 0.5rem;
        max-height: 200px;
        overflow-y: auto;
        padding-top: 0.5rem;
    }

    .icon-item {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .icon-item:hover {
        background: var(--gray-100);
    }

    .product-selection-item:hover {
        border-color: var(--blue-medium) !important;
        background: var(--gray-50) !important;
    }

    .product-selection-item.disabled {
        opacity: 0.5;
        pointer-events: none;
        background: var(--gray-100) !important;
    }

    .chosen-item {
        display: flex;
        align-items: center;
        background: var(--blue-darkest);
        color: white;
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        cursor: grab;
    }

    .chosen-item:active {
        cursor: grabbing;
    }

    .chosen-item .remove-btn {
        margin-left: auto;
        cursor: pointer;
        color: rgba(255, 255, 255, 0.6);
        transition: color 0.2s;
    }

    .chosen-item .remove-btn:hover {
        color: var(--danger);
    }

    /* Modern Image Upload Styles */
    .image-upload-dropzone {
        border: 2px dashed var(--gray-300);
        border-radius: 12px;
        padding: 2.5rem 2rem;
        text-align: center;
        background: var(--gray-50);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        position: relative;
        overflow: hidden;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 0.5rem;
    }

    .upload-progress-container {
        width: calc(100% - 20px);
        background-color: var(--gray-200);
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 30;
    }

    .upload-progress-bar {
        height: 100%;
        width: 0%;
        background-color: var(--blue-medium);
        border-radius: 8px;
        transition: width 0.3s ease-in-out;
        position: absolute;
        left: 0;
        top: 0;
    }

    .upload-status-text {
        position: relative;
        z-index: 1;
        color: var(--gray-700);
        font-size: 0.75rem;
        font-weight: 600;
    }

    .image-upload-dropzone:hover {
        border-color: var(--blue-medium);
        background: var(--white);
    }

    .image-upload-dropzone.drag-over {
        border-color: var(--blue-medium);
        background: rgba(0, 91, 150, 0.05);
        transform: scale(1.01);
        box-shadow: var(--shadow-md);
    }

    .dropzone-content {
        transition: var(--transition-base);
    }

    .dropzone-content i {
        font-size: 3.5rem;
        color: var(--blue-light);
        margin-bottom: 1.25rem;
        display: block;
        opacity: 0.8;
    }

    .dropzone-content p {
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }

    .dropzone-content p span {
        color: var(--blue-medium);
        text-decoration: underline;
    }

    .upload-hint {
        font-size: 0.85rem;
        color: var(--gray-400);
        display: block;
    }

    .image-preview-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        padding: 1rem;
    }

    .image-preview-container img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: var(--shadow-sm);
    }

    .image-preview-container.hidden {
        display: none;
    }

    .remove-image-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: var(--shadow-md);
        z-index: 20;
    }

    .remove-image-btn:hover {
        transform: scale(1.1) rotate(90deg);
        background: #c82333;
    }
</style>

<!-- Using SortableJS for product reordering -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
    const commonIcons = [
        'fa-solid fa-circle', 'fa-solid fa-check', 'fa-solid fa-star', 'fa-solid fa-shield-medical',
        'fa-solid fa-truck-fast', 'fa-solid fa-list-check', 'fa-solid fa-heart-pulse', 'fa-solid fa-kit-medical',
        'fa-solid fa-stethoscope', 'fa-solid fa-microscope', 'fa-solid fa-user-doctor', 'fa-solid fa-hospital',
        'fa-solid fa-award', 'fa-solid fa-certificate', 'fa-solid fa-lightbulb', 'fa-solid fa-bolt'
    ];

    function addSpecRow(icon = 'fa-solid fa-circle', text = '') {
        const container = document.getElementById('specsContainer');
        const index = container.children.length;
        const row = document.createElement('div');
        row.className = 'spec-row';
        row.innerHTML = `
            <div class="icon-picker-wrapper">
                <div class="icon-display" onclick="toggleIconDropdown(this)">
                    <i class="${icon}"></i>
                </div>
                <input type="hidden" name="spec_icons" value="${icon}">
                <div class="icon-dropdown">
                    <input type="text" placeholder="Search icon..." class="icon-search" oninput="filterIcons(this)" style="margin-bottom: 0.5rem; padding: 0.4rem; font-size: 0.8rem;">
                    <div class="icon-grid">
                        ${commonIcons.map(i => `<div class="icon-item" onclick="selectIcon(this, '${i}')"><i class="${i}"></i></div>`).join('')}
                    </div>
                </div>
            </div>
            <input type="text" name="spec_texts" value="${text}" placeholder="Enter highlight text..." style="flex: 1; margin: 0;">
            <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(row);
    }

    function toggleIconDropdown(el) {
        // Close all other dropdowns
        document.querySelectorAll('.icon-dropdown').forEach(d => {
            if (d !== el.nextElementSibling.nextElementSibling) d.classList.remove('show');
        });
        el.nextElementSibling.nextElementSibling.classList.toggle('show');
    }

    function selectIcon(el, iconClass) {
        const wrapper = el.closest('.icon-picker-wrapper');
        wrapper.querySelector('.icon-display i').className = iconClass;
        wrapper.querySelector('input[type="hidden"]').value = iconClass;
        wrapper.querySelector('.icon-dropdown').classList.remove('show');
    }

    function filterIcons(input) {
        const term = input.value.toLowerCase();
        const grid = input.nextElementSibling;
        grid.querySelectorAll('.icon-item').forEach(item => {
            const icon = item.querySelector('i').className.toLowerCase();
            item.style.display = icon.includes(term) ? 'flex' : 'none';
        });
    }

    // Product Selection Logic
    function toggleProductSelection(el) {
        const id = el.getAttribute('data-id');
        const model = el.querySelector('span:first-child').innerText;
        const code = el.querySelector('span:last-child').innerText;

        if (el.classList.contains('disabled')) return;

        el.classList.add('disabled');

        const chosenContainer = document.getElementById('chosenProducts');
        const chosenItem = document.createElement('div');
        chosenItem.className = 'chosen-item';
        chosenItem.setAttribute('data-id', id);
        chosenItem.innerHTML = `
            <i class="fas fa-grip-vertical" style="margin-right: 1rem; opacity: 0.5;"></i>
            <div style="display: flex; flex-direction: column;">
                <span style="font-weight: 600;">${model}</span>
                <span style="font-size: 0.7rem; opacity: 0.8;">${code}</span>
            </div>
            <input type="hidden" name="product_ids" value="${id}">
            <div class="remove-btn" onclick="removeProduct('${id}', this.parentElement)">
                <i class="fas fa-trash"></i>
            </div>
        `;
        chosenContainer.appendChild(chosenItem);
    }

    function removeProduct(id, itemEl) {
        itemEl.remove();
        const availableItem = document.querySelector(`.product-selection-item[data-id="${id}"]`);
        if (availableItem) availableItem.classList.remove('disabled');
    }

    // Initialize Sortable
    document.addEventListener('DOMContentLoaded', () => {
        new Sortable(document.getElementById('chosenProducts'), {
            animation: 150,
            ghostClass: 'blue-background-class'
        });

        // Add an initial spec row
        addSpecRow('fa-solid fa-list-check', '');

        // Image Upload Logic
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('main_image');
        const previewContainer = document.getElementById('image-preview-container');
        const previewImage = document.getElementById('image-preview');
        const removeBtn = document.getElementById('remove-image-btn');
        const dropzoneContent = document.getElementById('dropzone-content');

        dropzone.addEventListener('click', () => fileInput.click());

        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('drag-over');
        });

        ['dragleave', 'dragend'].forEach(type => {
            dropzone.addEventListener(type, () => {
                dropzone.classList.remove('drag-over');
            });
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewContainer.classList.remove('hidden');
                dropzoneContent.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.value = '';
            document.getElementById('main_image_path').value = '';
            previewContainer.classList.add('hidden');
            dropzoneContent.classList.remove('hidden');
            previewImage.src = '';
            document.getElementById('uploadProgressContainer').style.display = 'none';
        });

        async function uploadFileInChunks(file, progressContainerId) {
            const chunkSize = 750 * 1024; // 750KB
            const totalChunks = Math.ceil(file.size / chunkSize);
            const fileId = Date.now() + '-' + Math.round(Math.random() * 1e9);

            const container = document.getElementById(progressContainerId);
            const progressBar = container.querySelector('.upload-progress-bar');
            const statusText = container.querySelector('.upload-status-text');

            container.style.display = 'flex';

            for (let i = 0; i < totalChunks; i++) {
                const start = i * chunkSize;
                const end = Math.min(start + chunkSize, file.size);
                const chunk = file.slice(start, end);

                const formData = new FormData();
                formData.append('chunk', chunk);
                formData.append('chunkIndex', i);
                formData.append('totalChunks', totalChunks);
                formData.append('fileId', fileId);
                formData.append('fileName', file.name);

                try {
                    const response = await fetch('/admin/packages/upload-chunk', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (!result.success) throw new Error(result.error || 'Upload failed');

                    const percent = Math.round(((i + 1) / totalChunks) * 100);
                    progressBar.style.width = percent + '%';
                    statusText.textContent = `Uploading: ${percent}%`;

                    if (result.filePath) {
                        return result.filePath;
                    }
                } catch (error) {
                    console.error('Upload Error:', error);
                    throw error;
                }
            }
        }

        const packageForm = document.getElementById('packageForm');
        packageForm.addEventListener('submit', async function (e) {
            if (fileInput.files.length > 0 && !document.getElementById('main_image_path').value) {
                e.preventDefault();
                const submitBtn = document.getElementById('submitBtn');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading Image...';

                try {
                    const filePath = await uploadFileInChunks(fileInput.files[0], 'uploadProgressContainer');
                    document.getElementById('main_image_path').value = filePath;
                    packageForm.submit();
                } catch (err) {
                    alert('Image upload failed: ' + err.message);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            }
        });

        // Search in available products
        const searchInput = document.getElementById('productSearch');
        searchInput.addEventListener('input', function () {
            const term = this.value.toLowerCase();
            document.querySelectorAll('.product-selection-item').forEach(item => {
                const model = item.getAttribute('data-model');
                const code = item.getAttribute('data-code');
                item.style.display = (model.includes(term) || code.includes(term)) ? 'flex' : 'none';
            });
        });
    });

    // Close dropdowns on outside click
    window.onclick = function (event) {
        if (!event.target.closest('.icon-picker-wrapper')) {
            document.querySelectorAll('.icon-dropdown').forEach(d => d.classList.remove('show'));
        }
    }
</script>