<% const getProductNames=(idsString, productsList)=> {
    if (!idsString) return '<span style="color: var(--gray-400);">None</span>';
    const ids = idsString.split(',').map(Number);
    return productsList
    .filter(p => ids.includes(p.id))
    .map(p => `<span class="chip-static" style="font-size: 0.75rem; padding: 2px 8px; border-radius: 4px;">${p.code} -
        ${p.model}</span>`)
    .join(' ');
    };

    const renderLinks = (linksString) => {
    if (!linksString) return '<span style="color: var(--gray-400);">-</span>';
    const links = linksString.split('||').filter(l => l.trim() !== '');
    if (links.length === 0) return '<span style="color: var(--gray-400);">-</span>';
    return links
    .map((l, i) => {
    const parts = l.split('::');
    const title = parts[0];
    const url = parts.slice(1).join('::'); // Handle URLs containing :: just in case
    const displayTitle = title && title.trim() !== '' ? title : `Link ${i + 1}`;
    return `<a href="${url}" target="_blank" class="btn btn-outline btn-sm" title="${url}"
        style="padding: 2px 6px; font-size: 0.75rem;">
        <i class="fas fa-external-link-alt"></i> ${displayTitle}
    </a>`;
    })
    .join(' ');
    };
    %>
    <div class="companies-page">
        <div class="card-header marketing-header"
            style="justify-content: space-between; align-items: center; border-bottom: none; margin-bottom: 2rem; padding-bottom: 1rem; margin-top: 2rem;">
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <h1 style="margin: 0;">
                    <% if (activeTab==='materials' ) { %>
                        <%= selectedCategory ? (selectedCategory.charAt(0) + selectedCategory.slice(1).toLowerCase() +
                            (selectedCategory.endsWith('S') ? '' : 's' )) : 'Marketing Materials' %>
                            <% } %>
                                <% if (activeTab==='events' ) { %> Marketing Events <% } %>
                                        <% if (activeTab==='testimonies' ) { %> Client Testimonies <% } %>
                </h1>
                <% if (activeTab==='materials' ) { %>
                    <p style="margin: 0; color: var(--gray-500); font-size: 0.9rem;">
                        Filter by type to manage specialized product documentation.
                    </p>
                    <% } %>
            </div>
            <a href="/admin/marketing/<%= activeTab === 'materials' ? ('materials/add?category=' + selectedCategory) : (activeTab === 'events' ? 'events/add' : 'testimonies/add') %>"
                class="btn btn-primary add-company-btn">
                <i class="fas fa-plus"></i>
                <span>
                    Add <% if (activeTab==='materials' ) { %>
                        <%= selectedCategory ? (selectedCategory.charAt(0) + selectedCategory.slice(1).toLowerCase())
                            : 'Material' %>
                            <% } %>
                                <% if (activeTab==='events' ) { %> Event <% } %>
                                        <% if (activeTab==='testimonies' ) { %> Testimony <% } %>
                </span>
            </a>
        </div>

        <% if (activeTab==='materials' ) { %>
            <!-- Category tabs removed as they are now in the sidebar -->
            <% } %>

                <style>
                    .filter-row {
                        display: flex;
                        gap: 1rem;
                        align-items: center;
                        margin-bottom: 1.5rem;
                        padding-bottom: 1.5rem;
                        border-bottom: 1px solid var(--gray-200);
                        flex-wrap: wrap;
                    }

                    .multiselect-container {
                        position: relative;
                        min-width: 200px;
                        flex: 1;
                    }

                    .multiselect-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 0.75rem 1rem;
                        border: 1px solid var(--gray-300);
                        border-radius: 6px;
                        background: white;
                        cursor: pointer;
                        font-size: 0.95rem;
                        color: var(--gray-700);
                        transition: all 0.2s;
                        user-select: none;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }

                    .multiselect-header:hover {
                        border-color: var(--gray-400);
                    }

                    .multiselect-header.active {
                        border-color: var(--blue-medium);
                        box-shadow: 0 0 0 3px rgba(0, 91, 150, 0.1);
                    }

                    .multiselect-menu {
                        position: absolute;
                        top: 105%;
                        left: 0;
                        right: 0;
                        background: white;
                        border: 1px solid var(--gray-200);
                        border-radius: 8px;
                        box-shadow: var(--shadow-lg);
                        z-index: 1000;
                        max-height: 300px;
                        overflow-y: auto;
                        display: none;
                        padding: 0.5rem;
                    }

                    .multiselect-menu.show {
                        display: block;
                        animation: fadeIn 0.2s ease;
                    }

                    @keyframes fadeIn {
                        from {
                            opacity: 0;
                            transform: translateY(-10px);
                        }

                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }

                    .multiselect-item {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 0.6rem 0.8rem;
                        border-radius: 4px;
                        cursor: pointer;
                        transition: background 0.2s;
                    }

                    .multiselect-item:hover {
                        background: var(--gray-50);
                    }

                    .multiselect-item input[type="checkbox"] {
                        width: 18px;
                        height: 18px;
                        cursor: pointer;
                        accent-color: var(--blue-medium);
                    }

                    .multiselect-item span {
                        font-size: 0.9rem;
                        color: var(--gray-700);
                    }

                    .count-badge {
                        background: var(--blue-medium);
                        color: white;
                        font-size: 0.75rem;
                        padding: 2px 6px;
                        border-radius: 10px;
                        margin-left: 5px;
                    }

                    @media (max-width: 1024px) {
                        .filter-row {
                            flex-direction: column;
                            align-items: stretch;
                        }
                    }
                </style>

                <!-- Search & Filter Card -->
                <div class="card" style="margin-bottom: 2rem;">
                    <form
                        action="<%= activeTab === 'materials' ? '/admin/marketing/materials' : (activeTab === 'events' ? '/admin/marketing/events' : '/admin/marketing/testimonies') %>"
                        method="GET" class="filter-row" id="marketingFilterForm"
                        style="margin-bottom: 0; padding-bottom: 0; border-bottom: none;">

                        <div style="position: relative; flex: 2; min-width: 250px;">
                            <i class="fas fa-search"
                                style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray-400);"></i>
                            <input type="text" name="search" placeholder="Search..."
                                value="<%= typeof search !== 'undefined' ? search : '' %>"
                                style="width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            <% if (activeTab==='materials' ) { %>
                                <input type="hidden" name="category" value="<%= selectedCategory %>">
                                <% } %>
                        </div>

                        <% if (activeTab==='materials' && selectedCategory==='BROCHURE' ) { %>
                            <!-- Company Multiselect (Only for Brochures) -->
                            <div class="multiselect-container" id="companyFilter">
                                <div class="multiselect-header">
                                    <span class="header-text">Filter by Company</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multiselect-menu">
                                    <% companies.forEach(c=> { %>
                                        <label class="multiselect-item">
                                            <input type="checkbox" name="companies" value="<%= c.id %>"
                                                <%=(locals.selectedCompanies &&
                                                selectedCompanies.includes(String(c.id))) ? 'checked' : '' %>>
                                            <span>
                                                <%= c.name %>
                                            </span>
                                        </label>
                                        <% }) %>
                                </div>
                            </div>
                            <% } %>

                                <!-- Product Multiselect -->
                                <div class="multiselect-container" id="productFilter">
                                    <div class="multiselect-header">
                                        <span class="header-text">Filter by Product</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                    <div class="multiselect-menu">
                                        <% products.forEach(p=> { %>
                                            <label class="multiselect-item">
                                                <input type="checkbox" name="products" value="<%= p.id %>"
                                                    <%=(locals.selectedProducts &&
                                                    selectedProducts.includes(String(p.id))) ? 'checked' : '' %>>
                                                <span>
                                                    <%= p.code %> - <%= p.model %>
                                                </span>
                                            </label>
                                            <% }) %>
                                    </div>
                                </div>

                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button type="submit" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">
                                        <i class="fas fa-filter"></i> Apply
                                    </button>
                                    <a href="<%= activeTab === 'materials' ? '/admin/marketing/materials?category=' + selectedCategory : (activeTab === 'events' ? '/admin/marketing/events' : '/admin/marketing/testimonies') %>"
                                        class="btn btn-secondary" style="padding: 0.75rem 1.5rem;">
                                        <i class="fas fa-undo"></i> Reset
                                    </a>
                                </div>
                    </form>
                </div>

                <div class="card desktop-only">

                    <% if (activeTab==='materials' ) { %>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <% if (!selectedCategory) { %>
                                            <th>Type</th>
                                            <% } %>
                                                <% if (selectedCategory==='BROCHURE' ) { %>
                                                    <th>Affiliated Company</th>
                                                    <% } %>
                                                        <th>Linked Products</th>
                                                        <th>File</th>
                                                        <th style="width: 100px; text-align: center;">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if(marketing.length===0) { %>
                                        <tr>
                                            <td colspan="<%= selectedCategory === 'BROCHURE' ? 6 : 5 %>"
                                                style="text-align: center; color: var(--gray-500); padding: 3rem;">
                                                <div style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.3;">
                                                    <i class="fa-solid fa-folder-open"></i>
                                                </div>
                                                No <%= selectedCategory ? (selectedCategory.toLowerCase() +
                                                    (selectedCategory.endsWith('S') ? '' : 's' )) : 'items' %> found.
                                            </td>
                                        </tr>
                                        <% } %>
                                            <% marketing.forEach(m=> { %>
                                                <tr>
                                                    <td><strong>
                                                            <%= m.name %>
                                                        </strong></td>
                                                    <% if (!selectedCategory) { %>
                                                        <td>
                                                            <span class="badge badge-outline"
                                                                style="font-size: 0.7rem;">
                                                                <%= m.category %>
                                                            </span>
                                                        </td>
                                                        <% } %>
                                                            <% if (selectedCategory==='BROCHURE' ) { %>
                                                                <td>
                                                                    <% if (m.company_name) { %>
                                                                        <div
                                                                            style="display: flex; align-items: center; gap: 6px; font-weight: 500; color: var(--blue-darkest);">
                                                                            <i class="fa-solid fa-building"
                                                                                style="font-size: 0.8rem; color: var(--blue-medium);"></i>
                                                                            <%= m.company_name %>
                                                                        </div>
                                                                        <% } else { %>
                                                                            <span
                                                                                style="color: var(--gray-400);">General
                                                                                (All
                                                                                Companies)</span>
                                                                            <% } %>
                                                                </td>
                                                                <% } %>
                                                                    <td><%- getProductNames(m.product_ids, products) %>
                                                                    </td>
                                                                    <td><a href="<%= m.file_path %>" target="_blank"
                                                                            class="btn btn-outline btn-sm"><i
                                                                                class="fas fa-external-link-alt"></i>
                                                                            View File</a></td>
                                                                    <td>
                                                                        <div
                                                                            style="display: flex; gap: 8px; justify-content: center;">
                                                                            <a href="/admin/marketing/materials/edit/<%= m.id %>"
                                                                                class="btn btn-secondary btn-sm"><i
                                                                                    class="fas fa-edit"></i></a>
                                                                            <form
                                                                                action="/admin/marketing/materials/delete/<%= m.id %>"
                                                                                method="POST"
                                                                                onsubmit="return confirm('Delete this item?');">
                                                                                <button class="btn btn-danger btn-sm"><i
                                                                                        class="fas fa-trash"></i></button>
                                                                            </form>
                                                                        </div>
                                                                    </td>
                                                </tr>
                                                <% }) %>
                                </tbody>
                            </table>
                        </div>
                        <% } %>

                            <% if (activeTab==='events' ) { %>
                                <div class="table-responsive">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Event Name</th>
                                                <th>Location</th>
                                                <th>Dates</th>
                                                <th>Media Links</th>
                                                <th>Products</th>
                                                <th style="width: 100px; text-align: center;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% if(events.length===0) { %>
                                                <tr>
                                                    <td colspan="6" style="text-align: center; color: var(--gray-500);">
                                                        No
                                                        events
                                                        found.</td>
                                                </tr>
                                                <% } %>
                                                    <% events.forEach(e=> { %>
                                                        <tr>
                                                            <td><strong>
                                                                    <%= e.name %>
                                                                </strong></td>
                                                            <td>
                                                                <%= e.location || '-' %>
                                                            </td>
                                                            <td style="font-size: 0.85rem;">
                                                                <div style="white-space: nowrap;">
                                                                    <%= e.start_date ? new
                                                                        Date(e.start_date).toLocaleDateString() : '-' %>
                                                                </div>
                                                                <% if(e.end_date) { %>
                                                                    <div
                                                                        style="font-size: 0.75rem; color: var(--gray-500);">
                                                                        to
                                                                        <%= new Date(e.end_date).toLocaleDateString() %>
                                                                    </div>
                                                                    <% } %>
                                                            </td>
                                                            <td><%- renderLinks(e.links) %></td>
                                                            <td><%- getProductNames(e.product_ids, products) %></td>
                                                            <td>
                                                                <div
                                                                    style="display: flex; gap: 8px; justify-content: center;">
                                                                    <a href="/admin/marketing/events/edit/<%= e.id %>"
                                                                        class="btn btn-secondary btn-sm"><i
                                                                            class="fas fa-edit"></i></a>
                                                                    <form
                                                                        action="/admin/marketing/events/delete/<%= e.id %>"
                                                                        method="POST"
                                                                        onsubmit="return confirm('Delete this event?');">
                                                                        <button class="btn btn-danger btn-sm"><i
                                                                                class="fas fa-trash"></i></button>
                                                                    </form>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        <% }) %>
                                        </tbody>
                                    </table>
                                </div>
                                <% } %>

                                    <% if (activeTab==='testimonies' ) { %>
                                        <div class="table-responsive">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>Client</th>
                                                        <th>Treatment</th>
                                                        <th>Location</th>
                                                        <th>Date</th>
                                                        <th>Links</th>
                                                        <th>Products</th>
                                                        <th style="width: 100px; text-align: center;">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% if(testimonies.length===0) { %>
                                                        <tr>
                                                            <td colspan="7"
                                                                style="text-align: center; color: var(--gray-500);">
                                                                No
                                                                testimonies found.</td>
                                                        </tr>
                                                        <% } %>
                                                            <% testimonies.forEach(t=> { %>
                                                                <tr>
                                                                    <td><strong>
                                                                            <%= t.client_name %>
                                                                        </strong></td>
                                                                    <td>
                                                                        <%= t.treatment %>
                                                                    </td>
                                                                    <td>
                                                                        <%= t.location %>
                                                                    </td>
                                                                    <td style="font-size: 0.85rem;">
                                                                        <%= t.start_date ? new
                                                                            Date(t.start_date).toLocaleDateString()
                                                                            : '-' %>
                                                                    </td>
                                                                    <td><%- renderLinks(t.links) %></td>
                                                                    <td><%- getProductNames(t.product_ids, products) %>
                                                                    </td>
                                                                    <td>
                                                                        <div
                                                                            style="display: flex; gap: 8px; justify-content: center;">
                                                                            <a href="/admin/marketing/testimonies/edit/<%= t.id %>"
                                                                                class="btn btn-secondary btn-sm"><i
                                                                                    class="fas fa-edit"></i></a>
                                                                            <form
                                                                                action="/admin/marketing/testimonies/delete/<%= t.id %>"
                                                                                method="POST"
                                                                                onsubmit="return confirm('Delete this testimony?');">
                                                                                <button class="btn btn-danger btn-sm"><i
                                                                                        class="fas fa-trash"></i></button>
                                                                            </form>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                                <% }) %>
                                                </tbody>
                                            </table>
                                        </div>
                                        <% } %>
                </div>

                <!-- Mobile View -->
                <div class="mobile-category-cards">
                    <% if (activeTab==='materials' ) { %>
                        <% marketing.forEach(m=> { %>
                            <div class="category-card">
                                <div class="category-card-header">
                                    <div class="category-card-name">
                                        <div
                                            style="width: 40px; height: 40px; background: var(--gray-50); border-radius: 6px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--gray-100); margin-right: 10px; flex-shrink: 0;">
                                            <% let mIcon='fa-file-alt' ; if (m.category==='BROCHURE' )
                                                mIcon='fa-book-open' ; if (m.category==='FLIERS' )
                                                mIcon='fa-paper-plane' ; if (m.category==='ROLL-UP' ) mIcon='fa-scroll'
                                                ; if (m.category==='POSTER' ) mIcon='fa-image' ; if
                                                (m.category==='BACK-DROP' ) mIcon='fa-panorama' ; %>
                                                <i class="fas <%= mIcon %>"
                                                    style="color: var(--blue-medium); font-size: 1.25rem;"></i>
                                        </div>
                                        <div>
                                            <div>
                                                <%= m.name %>
                                            </div>
                                            <% if (!selectedCategory) { %>
                                                <span class="badge badge-outline"
                                                    style="font-size: 0.65rem; padding: 2px 6px; margin-top: 2px;">
                                                    <%= m.category %>
                                                </span>
                                                <% } %>
                                        </div>
                                    </div>
                                    <div class="category-card-actions">
                                        <a href="/admin/marketing/materials/edit/<%= m.id %>"
                                            class="btn btn-secondary btn-sm"><i class="fas fa-edit"></i></a>
                                        <form action="/admin/marketing/materials/delete/<%= m.id %>" method="POST"
                                            onsubmit="return confirm('Delete this?');">
                                            <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                                        </form>
                                    </div>
                                </div>
                                <div class="category-card-details"
                                    style="flex-direction: column; align-items: flex-start; gap: 8px;">
                                    <a href="<%= m.file_path %>" target="_blank"
                                        style="font-weight: 600; color: var(--blue-medium);">
                                        <i class="fas fa-external-link-alt" style="margin-right: 5px;"></i> View
                                        Document
                                    </a>
                                    <% if (m.category==='BROCHURE' && m.company_name) { %>
                                        <div
                                            style="font-size: 0.85rem; color: var(--blue-darkest); font-weight: 500; display: flex; align-items: center; gap: 6px; margin-top: 4px;">
                                            <i class="fa-solid fa-building" style="color: var(--blue-medium);"></i>
                                            <%= m.company_name %>
                                        </div>
                                        <% } %>
                                            <div
                                                style="padding-top: 8px; border-top: 1px solid var(--gray-100); width: 100%;">
                                                <div
                                                    style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 4px;">
                                                    Linked
                                                    Products</div>
                                                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                                    <%- getProductNames(m.product_ids, products) %>
                                                </div>
                                            </div>
                                </div>
                            </div>
                            <% }) %>
                                <% } %>

                                    <% if (activeTab==='events' ) { %>
                                        <% events.forEach(e=> { %>
                                            <div class="category-card">
                                                <div class="category-card-header">
                                                    <div class="category-card-name">
                                                        <div
                                                            style="width: 40px; height: 40px; background: var(--gray-50); border-radius: 6px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--gray-100); margin-right: 10px; flex-shrink: 0;">
                                                            <i class="fas fa-calendar-check"
                                                                style="color: var(--blue-medium); font-size: 1.25rem;"></i>
                                                        </div>
                                                        <div>
                                                            <div>
                                                                <%= e.name %>
                                                            </div>
                                                            <span class="badge badge-primary"
                                                                style="font-size: 0.65rem; padding: 2px 6px; margin-top: 2px;">Event</span>
                                                        </div>
                                                    </div>
                                                    <div class="category-card-actions">
                                                        <a href="/admin/marketing/events/edit/<%= e.id %>"
                                                            class="btn btn-secondary btn-sm"><i
                                                                class="fas fa-edit"></i></a>
                                                        <form action="/admin/marketing/events/delete/<%= e.id %>"
                                                            method="POST" onsubmit="return confirm('Delete event?');">
                                                            <button class="btn btn-danger btn-sm"><i
                                                                    class="fas fa-trash"></i></button>
                                                        </form>
                                                    </div>
                                                </div>
                                                <div class="category-card-details"
                                                    style="flex-direction: column; align-items: flex-start; gap: 8px;">
                                                    <div style="display: flex; align-items: center; gap: 8px;">
                                                        <i class="fas fa-map-marker-alt"
                                                            style="width: 14px; color: var(--gray-400);"></i>
                                                        <span>
                                                            <%= e.location || 'No location set' %>
                                                        </span>
                                                    </div>
                                                    <div style="display: flex; align-items: center; gap: 8px;">
                                                        <i class="fas fa-calendar-alt"
                                                            style="width: 14px; color: var(--gray-400);"></i>
                                                        <span>
                                                            <%= e.start_date ? new
                                                                Date(e.start_date).toLocaleDateString() : '-' %>
                                                                <% if(e.end_date) { %> - <%= new
                                                                        Date(e.end_date).toLocaleDateString() %>
                                                                        <% } %>
                                                        </span>
                                                    </div>
                                                    <div
                                                        style="width: 100%; padding-top: 8px; border-top: 1px solid var(--gray-50);">
                                                        <div
                                                            style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 5px;">
                                                            Media Links</div>
                                                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                                            <%- renderLinks(e.links) %>
                                                        </div>
                                                    </div>
                                                    <div
                                                        style="width: 100%; padding-top: 8px; border-top: 1px solid var(--gray-50);">
                                                        <div
                                                            style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 5px;">
                                                            Linked Products</div>
                                                        <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                                            <%- getProductNames(e.product_ids, products) %>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <% }) %>
                                                <% } %>

                                                    <% if (activeTab==='testimonies' ) { %>
                                                        <% testimonies.forEach(t=> { %>
                                                            <div class="category-card">
                                                                <div class="category-card-header">
                                                                    <div class="category-card-name">
                                                                        <div
                                                                            style="width: 40px; height: 40px; background: var(--gray-50); border-radius: 6px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--gray-100); margin-right: 10px; flex-shrink: 0;">
                                                                            <i class="fas fa-quote-left"
                                                                                style="color: var(--blue-medium); font-size: 1.25rem;"></i>
                                                                        </div>
                                                                        <div>
                                                                            <div>
                                                                                <%= t.client_name %>
                                                                            </div>
                                                                            <span class="badge badge-primary"
                                                                                style="font-size: 0.65rem; padding: 2px 6px; margin-top: 2px;">Testimony</span>
                                                                        </div>
                                                                    </div>
                                                                    <div class="category-card-actions">
                                                                        <a href="/admin/marketing/testimonies/edit/<%= t.id %>"
                                                                            class="btn btn-secondary btn-sm"><i
                                                                                class="fas fa-edit"></i></a>
                                                                        <form
                                                                            action="/admin/marketing/testimonies/delete/<%= t.id %>"
                                                                            method="POST"
                                                                            onsubmit="return confirm('Delete testimony?');">
                                                                            <button class="btn btn-danger btn-sm"><i
                                                                                    class="fas fa-trash"></i></button>
                                                                        </form>
                                                                    </div>
                                                                </div>
                                                                <div class="category-card-details"
                                                                    style="flex-direction: column; align-items: flex-start; gap: 8px;">
                                                                    <div
                                                                        style="display: flex; align-items: center; gap: 8px;">
                                                                        <i class="fas fa-stethoscope"
                                                                            style="width: 14px; color: var(--gray-400);"></i>
                                                                        <span>
                                                                            <%= t.treatment %>
                                                                        </span>
                                                                    </div>
                                                                    <div
                                                                        style="display: flex; align-items: center; gap: 8px;">
                                                                        <i class="fas fa-map-marker-alt"
                                                                            style="width: 14px; color: var(--gray-400);"></i>
                                                                        <span>
                                                                            <%= t.location %>
                                                                        </span>
                                                                    </div>
                                                                    <div
                                                                        style="display: flex; align-items: center; gap: 8px;">
                                                                        <i class="fas fa-calendar-check"
                                                                            style="width: 14px; color: var(--gray-400);"></i>
                                                                        <span>
                                                                            <%= t.start_date ? new
                                                                                Date(t.start_date).toLocaleDateString()
                                                                                : '-' %>
                                                                        </span>
                                                                    </div>
                                                                    <div
                                                                        style="width: 100%; padding-top: 8px; border-top: 1px solid var(--gray-50);">
                                                                        <div
                                                                            style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 5px;">
                                                                            Media Links</div>
                                                                        <div
                                                                            style="display: flex; flex-wrap: wrap; gap: 5px;">
                                                                            <%- renderLinks(t.links) %>
                                                                        </div>
                                                                    </div>
                                                                    <div
                                                                        style="width: 100%; padding-top: 8px; border-top: 1px solid var(--gray-50);">
                                                                        <div
                                                                            style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 5px;">
                                                                            Linked Products</div>
                                                                        <div
                                                                            style="display: flex; flex-wrap: wrap; gap: 4px;">
                                                                            <%- getProductNames(t.product_ids, products)
                                                                                %>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <% }) %>
                                                                <% } %>
                </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const setups = [
                { containerId: 'companyFilter', placeholder: 'Filter by Company' },
                { containerId: 'productFilter', placeholder: 'Filter by Product' }
            ];

            setups.forEach(setup => {
                const container = document.getElementById(setup.containerId);
                if (!container) return;

                const header = container.querySelector('.multiselect-header');
                const menu = container.querySelector('.multiselect-menu');
                const headerText = container.querySelector('.header-text');
                const checkboxes = menu.querySelectorAll('input[type="checkbox"]');

                header.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Close other menus
                    document.querySelectorAll('.multiselect-menu').forEach(m => {
                        if (m !== menu) m.classList.remove('show');
                    });
                    document.querySelectorAll('.multiselect-header').forEach(h => {
                        if (h !== header) h.classList.remove('active');
                    });

                    menu.classList.toggle('show');
                    header.classList.toggle('active');
                });

                menu.addEventListener('click', (e) => {
                    e.stopPropagation();
                });

                function updateHeaderText() {
                    const selected = Array.from(checkboxes).filter(cb => cb.checked);
                    if (selected.length === 0) {
                        headerText.textContent = setup.placeholder;
                    } else if (selected.length === 1) {
                        const label = selected[0].nextElementSibling.textContent;
                        headerText.textContent = label;
                    } else {
                        headerText.innerHTML = `${setup.placeholder} <span class="count-badge">${selected.length} Selected</span>`;
                    }
                }

                checkboxes.forEach(cb => {
                    cb.addEventListener('change', updateHeaderText);
                });

                // Initial text
                updateHeaderText();
            });

            // Close on outside click
            document.addEventListener('click', () => {
                document.querySelectorAll('.multiselect-menu').forEach(m => m.classList.remove('show'));
                document.querySelectorAll('.multiselect-header').forEach(h => h.classList.remove('active'));
            });
        });
    </script>

    <style>
        .tab-trigger.active {
            color: var(--blue-medium);
            border-bottom: 2px solid var(--blue-medium);
        }

        .tab.active {
            color: var(--blue-medium) !important;
            border-bottom-color: var(--blue-medium) !important;
            font-weight: 700;
            background: rgba(0, 91, 150, 0.03);
        }
    </style>