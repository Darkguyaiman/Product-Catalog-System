<div class="companies-page">
    <div class="card-header companies-header">
        <h1 id="pageTitle">Edit <%= material.category ? (material.category.charAt(0) +
                material.category.slice(1).toLowerCase()) : 'Marketing Material' %>
        </h1>
        <a href="/admin/marketing/materials?category=<%= material.category %>" class="btn btn-secondary btn-sm"
            title="Go Back">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>

    <div class="card" style="max-width: 900px; margin: 0 auto;">
        <form action="/admin/marketing/materials/edit/<%= material.id %>" method="POST" enctype="multipart/form-data"
            id="editMaterialForm">
            <div class="form-group">
                <label>Title/Name <span style="color: var(--danger);">*</span></label>
                <input type="text" name="name" required value="<%= material.name %>">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <input type="hidden" name="category" id="categoryInput" value="<%= material.category %>">

                <div class="form-group" id="companyGroup" style="display: block;">
                    <label>Affiliated Company</label>
                    <select name="company_id">
                        <option value="">General (All Companies)</option>
                        <% companies.forEach(c=> { %>
                            <option value="<%= c.id %>" <%=material.company_id===c.id ? 'selected' : '' %>><%= c.name %>
                            </option>
                            <% }) %>
                    </select>
                    <p style="font-size: 0.75rem; color: var(--gray-500); margin-top: 4px;">
                        Specify a company if this brochure is tailored for them.
                    </p>
                </div>
            </div>

            <div class="form-group">
                <label>Upload File (Leave empty to keep current)</label>
                <div class="upload-zone" id="fileUploadZone">
                    <div class="upload-content" style="<%= material.file_path ? 'display: none;' : '' %>">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <p class="upload-text">Drag and drop to replace or <span class="browse-link">browse</span></p>
                        <p class="upload-hint">PDF, JPG, PNG, WEBP, PPTX, XLSX (Max 5MB)</p>
                    </div>
                    <input type="file" id="fileInput" style="display: none;" accept=".pdf,.pptx,.xlsx,image/*">
                    <input type="hidden" name="file_path" id="filePathInput">
                    <input type="hidden" name="file_mime" id="fileMimeInput">
                    <input type="hidden" name="existing_file" value="<%= material.file_path %>">

                    <div id="uploadProgressContainer" class="upload-progress-container"
                        style="display: none; margin-top: 10px;">
                        <div class="upload-progress-bar" id="uploadProgressBar"></div>
                        <span class="upload-status-text" id="uploadStatusText"></span>
                    </div>

                    <div id="filePreview" class="file-preview"
                        style="<%= material.file_path ? 'display: flex;' : 'display: none;' %>">
                        <div id="previewIcon"
                            style="font-size: 3rem; color: var(--blue-medium); margin-bottom: 0.5rem;">
                            <% if (material.file_path) { %>
                                <% if (material.file_path.endsWith('.pdf')) { %> <i class="fas fa-file-pdf"></i>
                                    <% } else if (material.file_path.endsWith('.pptx')) { %> <i
                                            class="fas fa-file-powerpoint"></i>
                                        <% } else if (material.file_path.endsWith('.xlsx')) { %> <i
                                                class="fas fa-file-excel"></i>
                                            <% } else { %> <i class="fas fa-file-alt"></i>
                                                <% } %>
                                                    <% } else { %>
                                                        <i class="fas fa-file-alt"></i>
                                                        <% } %>
                        </div>
                        <img id="previewImg"
                            src="<%= material.file_type && material.file_type.startsWith('image/') ? material.file_path : '' %>"
                            alt="Preview"
                            style="display:<%= material.file_type && material.file_type.startsWith('image/') ? 'block' : 'none' %>; max-width: 200px; max-height: 200px; object-fit: contain; border: 1px solid var(--gray-200); border-radius: 8px; margin-bottom: 0.5rem;">

                        <div class="file-info" id="fileInfoChip">
                            <span id="fileName" class="file-name">
                                <%= material.file_path ? 'Current File' : '' %>
                            </span>
                            <button type="button" class="remove-file" id="removeFile" style="display:none;"><i
                                    class="fas fa-times"></i></button>
                        </div>
                        <p style="font-size: 0.8rem; color: var(--gray-500); margin-top:5px;" id="currentFileHint">
                            <%= material.file_path ? 'Uploading a new file will replace the current one.' : '' %>
                        </p>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Linked Products</label>
                <div class="chip-wrapper" id="productChipWrapper">
                    <select id="productSelectInput">
                        <option value="">Add Product...</option>
                        <% products.forEach(p=> { %>
                            <option value="<%= p.id %>">
                                <%= p.code %> - <%= p.model %>
                            </option>
                            <% }) %>
                    </select>
                </div>
                <select name="product_ids" id="productHiddenSelect" multiple style="display:none;">
                    <% products.forEach(p=> { %>
                        <option value="<%= p.id %>" <%=(material.product_ids || []).includes(p.id) ? 'selected' : '' %>>
                            <%= p.code %> - <%= p.model %>
                        </option>
                        <% }) %>
                </select>
            </div>

            <div
                style="display: flex; gap: 15px; margin-top: 2rem; border-top: 1px solid var(--gray-100); padding-top: 2rem;">
                <button type="submit" class="btn btn-primary" id="submitBtn" style="flex: 2;">
                    <i class="fas fa-save"></i> <span>Update Material</span>
                </button>
                <a href="/admin/marketing/materials?category=<%= material.category %>" class="btn btn-secondary"
                    style="flex: 1;">Cancel</a>
            </div>
        </form>
    </div>
</div>

<style>
    .upload-progress-container {
        width: 100%;
        background-color: var(--gray-200);
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .upload-progress-bar {
        height: 100%;
        width: 0%;
        background-color: var(--blue-medium);
        border-radius: 8px;
        transition: width 0.3s ease-in-out;
        position: absolute;
        left: 0;
        top: 0;
    }

    .upload-status-text {
        position: relative;
        z-index: 1;
        color: var(--gray-700);
        font-size: 0.85rem;
        font-weight: 600;
    }

    .file-preview {
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Toggle Company Select logic
        const categoryInput = document.getElementById('categoryInput');
        const companyGroup = document.getElementById('companyGroup');

        function toggleCompanyGroup() {
            if (categoryInput.value === 'BROCHURE') {
                companyGroup.style.display = 'block';
            } else {
                companyGroup.style.display = 'none';
            }
        }

        function updatePageTitle() {
            const val = categoryInput.value;
            const pageTitle = document.getElementById('pageTitle');
            if (val) {
                const formatted = val.charAt(0) + val.slice(1).toLowerCase();
                pageTitle.textContent = 'Edit ' + formatted;
            } else {
                pageTitle.textContent = 'Edit Marketing Material';
            }
        }

        categoryInput.addEventListener('change', () => {
            toggleCompanyGroup();
            updatePageTitle();
        });
        toggleCompanyGroup();
        updatePageTitle();

        // Chip Logic
        const wrapper = document.getElementById('productChipWrapper');
        const selectInput = document.getElementById('productSelectInput');
        const hiddenSelect = document.getElementById('productHiddenSelect');

        function updateChips() {
            wrapper.querySelectorAll('.chip').forEach(c => c.remove());
            Array.from(hiddenSelect.options).forEach(opt => {
                if (opt.selected) {
                    const chip = document.createElement('div');
                    chip.className = 'chip';
                    chip.innerHTML = `${opt.text} <button type="button" class="chip-remove" data-value="${opt.value}"><i class="fas fa-times"></i></button>`;
                    wrapper.insertBefore(chip, selectInput);
                }
            });
            wrapper.querySelectorAll('.chip-remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const realVal = e.currentTarget.dataset.value;
                    const opt = hiddenSelect.querySelector(`option[value="${realVal}"]`);
                    if (opt) opt.selected = false;
                    updateChips();
                });
            });
            Array.from(hiddenSelect.options).forEach(opt => {
                const inputOpt = selectInput.querySelector(`option[value="${opt.value}"]`);
                if (inputOpt) {
                    inputOpt.disabled = opt.selected;
                    inputOpt.style.display = opt.selected ? 'none' : 'block';
                }
            });
            selectInput.value = "";
        }
        selectInput.addEventListener('change', () => {
            if (selectInput.value) {
                hiddenSelect.querySelector(`option[value="${selectInput.value}"]`).selected = true;
                updateChips();
            }
        });
        updateChips();

        // File Logic
        const zone = document.getElementById('fileUploadZone');
        const input = document.getElementById('fileInput');
        const content = zone.querySelector('.upload-content');
        const preview = document.getElementById('filePreview');
        const previewImg = document.getElementById('previewImg');
        const previewIcon = document.getElementById('previewIcon');
        const fileName = document.getElementById('fileName');
        const removeBtn = document.getElementById('removeFile');
        const currentFileHint = document.getElementById('currentFileHint');
        const filePathInput = document.getElementById('filePathInput');
        const fileMimeInput = document.getElementById('fileMimeInput');

        zone.addEventListener('click', (e) => {
            if (e.target !== removeBtn && !removeBtn.contains(e.target)) input.click();
        });

        input.addEventListener('change', () => {
            if (input.files.length) {
                const file = input.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    alert('File too large. Max 5MB.');
                    input.value = '';
                    return;
                }

                content.style.display = 'none';
                preview.style.display = 'flex';
                fileName.textContent = file.name;
                removeBtn.style.display = 'flex';
                if (currentFileHint) currentFileHint.style.display = 'none';
                filePathInput.value = '';

                if (file.type.startsWith('image/')) {
                    previewIcon.style.display = 'none';
                    previewImg.style.display = 'block';
                    const reader = new FileReader();
                    reader.onload = (e) => previewImg.src = e.target.result;
                    reader.readAsDataURL(file);
                } else {
                    previewImg.style.display = 'none';
                    previewIcon.style.display = 'block';
                    if (file.name.endsWith('.pdf')) previewIcon.innerHTML = '<i class="fas fa-file-pdf"></i>';
                    else if (file.name.endsWith('.pptx')) previewIcon.innerHTML = '<i class="fas fa-file-powerpoint"></i>';
                    else if (file.name.endsWith('.xlsx')) previewIcon.innerHTML = '<i class="fas fa-file-excel"></i>';
                    else previewIcon.innerHTML = '<i class="fas fa-file-alt"></i>';
                }
            }
        });

        removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            input.value = '';
            filePathInput.value = '';
            const hasInitial = <%= material.file_path ? 'true' : 'false' %>;
            if (hasInitial) {
                fileName.textContent = 'Current File';
                removeBtn.style.display = 'none';
                if (currentFileHint) currentFileHint.style.display = 'block';

                // Clear previews for new uploads if we went back to original
                <% if (material.file_type && material.file_type.startsWith('image/')) { %>
                    previewImg.src = "<%= material.file_path %>";
                    previewImg.style.display = 'block';
                    previewIcon.style.display = 'none';
                <% } else { %>
                    previewImg.style.display = 'none';
                    previewIcon.style.display = 'block';
                    <% if (material.file_path && material.file_path.endsWith('.pdf')) { %> previewIcon.innerHTML = '<i class="fas fa-file-pdf"></i>';
                    <% } else if (material.file_path && material.file_path.endsWith('.pptx')) { %> previewIcon.innerHTML = '<i class="fas fa-file-powerpoint"></i>';
                    <% } else if (material.file_path && material.file_path.endsWith('.xlsx')) { %> previewIcon.innerHTML = '<i class="fas fa-file-excel"></i>';
                    <% } %>
                <% } %>
            } else {
                content.style.display = 'block';
                preview.style.display = 'none';
            }
            document.getElementById('uploadProgressContainer').style.display = 'none';
        });

        // Form Submit with Chunked Upload
        document.getElementById('editMaterialForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const file = input.files[0];

            btn.classList.add('btn-loading');
            btn.disabled = true;
            btn.querySelector('span').textContent = 'Processing...';

            try {
                if (file && !filePathInput.value) {
                    const chunkSize = 750 * 1024; // 750KB
                    const totalChunks = Math.ceil(file.size / chunkSize);
                    const fileId = Date.now() + '-' + Math.round(Math.random() * 1e9);

                    document.getElementById('uploadProgressContainer').style.display = 'flex';
                    const progressBar = document.getElementById('uploadProgressBar');
                    const statusText = document.getElementById('uploadStatusText');

                    for (let i = 0; i < totalChunks; i++) {
                        const start = i * chunkSize;
                        const end = Math.min(start + chunkSize, file.size);
                        const chunk = file.slice(start, end);

                        const formData = new FormData();
                        formData.append('chunk', chunk);
                        formData.append('chunkIndex', i);
                        formData.append('totalChunks', totalChunks);
                        formData.append('fileId', fileId);
                        formData.append('fileName', file.name);
                        formData.append('mimeType', file.type);

                        const response = await fetch('/admin/marketing/upload-chunk', {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();
                        if (!result.success) throw new Error(result.error || 'Upload failed');

                        const percent = Math.round(((i + 1) / totalChunks) * 100);
                        progressBar.style.width = percent + '%';
                        statusText.textContent = `Uploading: ${percent}%`;

                        if (result.filePath) {
                            filePathInput.value = result.filePath;
                            fileMimeInput.value = result.mimeType;
                        }
                    }
                }

                btn.querySelector('span').textContent = 'Updating...';
                this.submit();
            } catch (error) {
                console.error(error);
                alert('Upload failed: ' + error.message);
                btn.classList.remove('btn-loading');
                btn.disabled = false;
                btn.querySelector('span').textContent = 'Update Material';
            }
        });
    });
</script>