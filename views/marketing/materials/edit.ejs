<div class="card-header marketing-header">
    <h1>Edit Marketing Material</h1>
    <a href="/admin/marketing" class="btn btn-secondary btn-sm" title="Go Back">
        <i class="fas fa-arrow-left"></i>
    </a>
</div>

<div class="card" style="max-width: 800px; margin: 20px auto;">
    <form action="/admin/marketing/materials/edit/<%= material.id %>" method="POST" enctype="multipart/form-data"
        id="editMaterialForm">
        <div class="form-group">
            <label>Title/Name <span style="color: var(--danger);">*</span></label>
            <input type="text" name="name" required value="<%= material.name %>">
        </div>

        <div class="form-group">
            <label>Upload File (Leave empty to keep current)</label>
            <div class="upload-zone" id="fileUploadZone">
                <div class="upload-content" style="<%= material.file_path ? 'display: none;' : '' %>">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <p class="upload-text">Drag and drop to replace or <span class="browse-link">browse</span></p>
                    <p class="upload-hint">PDF, JPG, PNG (Max 10MB)</p>
                </div>
                <!-- Not required on edit -->
                <input type="file" name="file" id="fileInput" style="display: none;">

                <div id="filePreview" class="file-preview"
                    style="<%= material.file_path ? 'display: flex;' : 'display: none;' %>">
                    <div id="previewIcon" style="font-size: 3rem; color: var(--blue-medium); margin-bottom: 0.5rem;">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="file-info" id="fileInfoChip">
                        <span id="fileName" class="file-name">
                            <%= material.file_path ? 'Current File' : '' %>
                        </span>
                        <button type="button" class="remove-file" id="removeFile" style="display:none;"><i
                                class="fas fa-times"></i></button>
                        <!-- Hide remove for current because backend doesn't support 'clearing' file, only replacing -->
                    </div>
                    <p style="font-size: 0.8rem; color: var(--gray-500); margin-top:5px;" id="currentFileHint">Uploading
                        a new file will replace the current one.</p>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Linked Products</label>
            <div class="chip-wrapper" id="productChipWrapper">
                <select id="productSelectInput">
                    <option value="">Add Product...</option>
                    <% products.forEach(p=> { %>
                        <option value="<%= p.id %>">
                            <%= p.code %> - <%= p.model %>
                        </option>
                        <% }) %>
                </select>
            </div>
            <select name="product_ids" id="productHiddenSelect" multiple style="display:none;">
                <% products.forEach(p=> { %>
                    <option value="<%= p.id %>" <%=(material.product_ids || []).includes(p.id) ? 'selected' : '' %>>
                        <%= p.code %> - <%= p.model %>
                    </option>
                    <% }) %>
            </select>
        </div>

        <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--gray-100);">
            <button type="submit" class="btn btn-primary" style="width: 100%;">Update Material</button>
        </div>
    </form>
</div>

<style>
    .chip-wrapper {
        border: 1px solid var(--gray-300);
        border-radius: 6px;
        padding: 0.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        min-height: 45px;
        background: white;
        align-items: center;
    }

    .chip-wrapper:focus-within {
        border-color: var(--blue-medium);
        box-shadow: 0 0 0 3px rgba(0, 91, 150, 0.1);
    }

    .chip {
        background: var(--blue-lightest);
        color: var(--blue-dark);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
        border: 1px solid var(--blue-light);
    }

    .chip-remove {
        background: none;
        border: none;
        color: var(--blue-medium);
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
    }

    .chip-remove:hover {
        color: var(--danger);
    }

    .chip-wrapper select {
        border: none;
        outline: none;
        padding: 4px;
        flex: 1;
        min-width: 150px;
        font-size: 0.95rem;
        background: transparent;
    }

    .upload-zone {
        border: 2px dashed var(--gray-300);
        border-radius: 12px;
        padding: 2.5rem 1.5rem;
        text-align: center;
        background: var(--gray-50);
        transition: all 0.2s;
        cursor: pointer;
    }

    .upload-zone:hover {
        border-color: var(--blue-medium);
        background: rgba(0, 91, 150, 0.05);
    }

    .upload-icon {
        font-size: 3rem;
        color: var(--gray-400);
        margin-bottom: 1rem;
    }

    .file-preview {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

    .file-info {
        display: flex;
        align-items: center;
        gap: 10px;
        background: white;
        padding: 8px 15px;
        border-radius: 20px;
        border: 1px solid var(--gray-200);
        box-shadow: var(--shadow-sm);
    }

    .remove-file {
        background: #fee2e2;
        color: var(--danger);
        border: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const wrapper = document.getElementById('productChipWrapper');
        const selectInput = document.getElementById('productSelectInput');
        const hiddenSelect = document.getElementById('productHiddenSelect');

        function updateChips() {
            wrapper.querySelectorAll('.chip').forEach(c => c.remove());
            Array.from(hiddenSelect.options).forEach(opt => {
                if (opt.selected) {
                    const chip = document.createElement('div');
                    chip.className = 'chip';
                    chip.innerHTML = `${opt.text} <button type="button" class="chip-remove" data-value="${opt.value}"><i class="fas fa-times"></i></button>`;
                    wrapper.insertBefore(chip, selectInput);
                }
            });
            wrapper.querySelectorAll('.chip-remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const realVal = e.currentTarget.dataset.value;
                    const opt = hiddenSelect.querySelector(`option[value="${realVal}"]`);
                    if (opt) opt.selected = false;
                    updateChips();
                });
            });
            Array.from(hiddenSelect.options).forEach(opt => {
                const inputOpt = selectInput.querySelector(`option[value="${opt.value}"]`);
                if (inputOpt) {
                    inputOpt.disabled = opt.selected;
                    inputOpt.style.display = opt.selected ? 'none' : 'block';
                }
            });
            selectInput.value = "";
        }
        selectInput.addEventListener('change', () => {
            if (selectInput.value) {
                hiddenSelect.querySelector(`option[value="${selectInput.value}"]`).selected = true;
                updateChips();
            }
        });
        updateChips();

        // File Logic
        const zone = document.getElementById('fileUploadZone');
        const input = document.getElementById('fileInput');
        const content = zone.querySelector('.upload-content');
        const preview = document.getElementById('filePreview');
        const fileName = document.getElementById('fileName');
        const removeBtn = document.getElementById('removeFile'); // For New uploads

        zone.addEventListener('click', (e) => {
            if (e.target !== removeBtn && !removeBtn.contains(e.target)) input.click();
        });

        input.addEventListener('change', () => {
            if (input.files.length) {
                content.style.display = 'none';
                preview.style.display = 'flex';
                fileName.textContent = input.files[0].name;
                removeBtn.style.display = 'flex'; // Allow undo of draft upload
                document.getElementById('currentFileHint').style.display = 'none';
            }
        });

        removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            input.value = '';
            // If there was a current file, we should show "Current File" again.
            // Simplified: Revert to initial state
            // But we don't know if initial state was "has file" or "empty" easily without serverside logic again or dirty checking
            // However, based on template logic:
            const hasInitial = <%= material.file_path ? 'true' : 'false' %>;
            if (hasInitial) {
                fileName.textContent = 'Current File';
                removeBtn.style.display = 'none';
                document.getElementById('currentFileHint').style.display = 'block';
            } else {
                content.style.display = 'block';
                preview.style.display = 'none';
            }
        });
    });
</script>