<div class="companies-page">
    <div class="card-header companies-header">
        <h1>Add New Event</h1>
        <a href="/admin/marketing/events" class="btn btn-secondary btn-sm" title="Go Back">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>

    <div class="card" style="max-width: 900px; margin: 0 auto;">
        <form action="/admin/marketing/events/add" method="POST" id="addEventForm">
            <div class="grid-2">
                <div class="form-group">
                    <label>Event Name <span style="color: var(--danger);">*</span></label>
                    <input type="text" name="name" required placeholder="e.g. Annual Health Expo">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" name="location" placeholder="e.g. KLCC Convention Centre">
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" name="start_date">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" name="end_date">
                </div>
            </div>

            <div class="form-group">
                <label>Media Links (Photos/Videos)</label>
                <div id="links-container">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" name="link_titles" placeholder="Link Name (e.g. Photo Gallery)"
                            style="flex: 1;">
                        <input type="url" name="link_urls" placeholder="https://" style="flex: 2;">
                        <button type="button" class="btn btn-secondary btn-sm" disabled
                            style="color: var(--gray-400); border-color: var(--gray-200);">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary btn-sm" onclick="addLinkInput()"
                    style="margin-top: 5px;">
                    <i class="fas fa-plus"></i> Add Another Link
                </button>
            </div>

            <div class="form-group">
                <label>Linked Products</label>
                <div class="chip-wrapper" id="productChipWrapper">
                    <select id="productSelectInput">
                        <option value="">Add Product...</option>
                        <% products.forEach(p=> { %>
                            <option value="<%= p.id %>">
                                <%= p.code %> - <%= p.model %>
                            </option>
                            <% }) %>
                    </select>
                </div>
                <select name="product_ids" id="productHiddenSelect" multiple style="display:none;">
                    <% products.forEach(p=> { %>
                        <option value="<%= p.id %>">
                            <%= p.code %> - <%= p.model %>
                        </option>
                        <% }) %>
                </select>
            </div>

            <div
                style="display: flex; gap: 15px; margin-top: 2rem; border-top: 1px solid var(--gray-100); padding-top: 2rem;">
                <button type="submit" class="btn btn-primary" id="submitBtn" style="flex: 2;">
                    <i class="fas fa-save"></i> <span>Save Event</span>
                </button>
                <a href="/admin/marketing/events" class="btn btn-secondary" style="flex: 1;">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
    function addLinkInput() {
        const container = document.getElementById('links-container');
        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.gap = '10px';
        div.style.marginBottom = '10px';
        div.innerHTML = `
            <input type="text" name="link_titles" placeholder="Link Name" style="flex: 1;">
            <input type="url" name="link_urls" placeholder="https://" style="flex: 2;">
            <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        `;
        container.appendChild(div);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const wrapper = document.getElementById('productChipWrapper');
        const selectInput = document.getElementById('productSelectInput');
        const hiddenSelect = document.getElementById('productHiddenSelect');

        function updateChips() {
            wrapper.querySelectorAll('.chip').forEach(c => c.remove());
            Array.from(hiddenSelect.options).forEach(opt => {
                if (opt.selected) {
                    const chip = document.createElement('div');
                    chip.className = 'chip';
                    chip.innerHTML = `${opt.text} <button type="button" class="chip-remove" data-value="${opt.value}"><i class="fas fa-times"></i></button>`;
                    wrapper.insertBefore(chip, selectInput);
                }
            });
            wrapper.querySelectorAll('.chip-remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const realVal = e.currentTarget.dataset.value;
                    const opt = hiddenSelect.querySelector(`option[value="${realVal}"]`);
                    if (opt) opt.selected = false;
                    updateChips();
                });
            });
            Array.from(hiddenSelect.options).forEach(opt => {
                const inputOpt = selectInput.querySelector(`option[value="${opt.value}"]`);
                if (inputOpt) {
                    inputOpt.disabled = opt.selected;
                    inputOpt.style.display = opt.selected ? 'none' : 'block';
                }
            });
            selectInput.value = "";
        }
        selectInput.addEventListener('change', () => {
            if (selectInput.value) {
                hiddenSelect.querySelector(`option[value="${selectInput.value}"]`).selected = true;
                updateChips();
            }
        });
        updateChips();

        // Submit loading state
        document.getElementById('addEventForm').addEventListener('submit', function () {
            const btn = document.getElementById('submitBtn');
            btn.classList.add('btn-loading');
            btn.disabled = true;
            btn.querySelector('span').textContent = 'Saving...';
        });
    });
</script>