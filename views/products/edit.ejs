<div class="companies-page">
    <div class="card-header companies-header">
        <h1>Edit Product: <%= product.model %>
        </h1>
        <a href="/admin/products" class="btn btn-secondary btn-sm" title="Go Back">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>

    <div class="card" style="max-width: 900px; margin: 0 auto;">
        <form id="editProductForm" action="/admin/products/edit/<%= product.id %>" method="POST"
            enctype="multipart/form-data">

            <h3
                style="margin-bottom: 1.5rem; font-size: 1.1rem; color: var(--blue-dark); border-bottom: 1px solid var(--gray-200); padding-bottom: 0.5rem;">
                Basic Information</h3>

            <div class="form-group" style="margin-bottom: 2rem;">
                <label>Product Images <span style="color: var(--gray-500); font-size: 0.85rem; font-weight: normal;">(Select main image with star)</span></label>
                <div class="upload-zone" id="imageUploadZone">
                    <div class="upload-content">
                        <i class="fas fa-images upload-icon"></i>
                        <p class="upload-text">Drag and drop product images here or <span
                                class="browse-link">browse</span></p>
                        <p class="upload-hint">PNG, JPG, WEBP (Max 5MB each, up to 10 images)</p>
                    </div>
                    <input type="file" name="product_images" id="imageInput" accept="image/*" multiple style="display: none;">
                </div>
                <div id="imagesPreviewContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    <% if (product.images && product.images.length > 0) { %>
                        <% product.images.forEach((img, index) => { %>
                            <div class="existing-image-card" data-image-id="<%= img.id %>" style="position: relative; border: 2px solid <%= img.is_main ? 'var(--blue-medium)' : 'var(--gray-200)' %>; border-radius: 8px; overflow: hidden; background: var(--gray-50);">
                                <img src="<%= img.image_path %>" alt="Product Image" style="width: 100%; height: 150px; object-fit: cover; display: block;">
                                <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 4px;">
                                    <button type="button" class="star-btn existing-star-btn <%= img.is_main ? 'active' : '' %>" 
                                        data-image-id="<%= img.id %>" style="background: rgba(255,255,255,0.9); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <i class="fas fa-star" style="color: <%= img.is_main ? '#FFD700' : '#ccc' %>;"></i>
                                    </button>
                                    <button type="button" class="remove-existing-btn" data-image-id="<%= img.id %>" 
                                        style="background: rgba(220,38,38,0.9); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <% if (img.is_main) { %>
                                    <div class="main-label" style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,91,150,0.9); color: white; padding: 4px; text-align: center; font-size: 0.75rem; font-weight: 600;">Main Image</div>
                                <% } %>
                                <input type="hidden" name="existing_images[]" value="<%= img.id %>">
                            </div>
                        <% }) %>
                    <% } %>
                </div>
                <input type="hidden" name="main_image_id" id="mainImageId" value="<%= product.images && product.images.find(img => img.is_main) ? product.images.find(img => img.is_main).id : '' %>">
                <input type="hidden" name="deleted_images" id="deletedImages" value="">
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label>Product Code <span style="color: var(--danger);">*</span></label>
                    <input type="text" name="code" value="<%= product.code %>" required>
                </div>
                <div class="form-group">
                    <label>Product Model</label>
                    <input type="text" name="model" value="<%= product.model %>">
                </div>
                <div class="form-group">
                    <label>Product Reg. No.</label>
                    <input type="text" name="reg_no" value="<%= product.reg_no %>">
                </div>
                <div class="form-group">
                    <label>Product MDA Reg. No.</label>
                    <input type="text" name="mda_reg_no" value="<%= product.mda_reg_no %>">
                </div>
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label>Supplier</label>
                    <select name="supplier_id">
                        <option value="">Select Supplier...</option>
                        <% if (suppliers && suppliers.length > 0) { %>
                            <% suppliers.forEach(supplier => { %>
                                <option value="<%= supplier.id %>" <%= product.supplier_id == supplier.id ? 'selected' : '' %>>
                                    <%= supplier.name %><% if (supplier.country) { %> - <%= supplier.country %><% } %>
                                </option>
                            <% }) %>
                        <% } %>
                    </select>
                </div>
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label>Product Types</label>
                    <div class="chip-wrapper" id="typeChipWrapper">
                        <select id="typeSelectInput">
                            <option value="">Add Type...</option>
                            <% types.forEach(t=> { %>
                                <option value="<%= t.value %>">
                                    <%= t.value %>
                                </option>
                                <% }) %>
                        </select>
                    </div>
                    <select name="product_types" id="typeHiddenSelect" multiple style="display:none;">
                        <% types.forEach(t=> { %>
                            <option value="<%= t.value %>" <%=(product.product_types || []).includes(t.value)
                                ? 'selected' : '' %>>
                                <%= t.value %>
                            </option>
                            <% }) %>
                    </select>
                </div>
                <div class="form-group">
                    <label>Categories</label>
                    <div class="chip-wrapper" id="categoryChipWrapper">
                        <select id="categorySelectInput">
                            <option value="">Add Category...</option>
                            <% categories.forEach(c=> { %>
                                <option value="<%= c.id %>">
                                    <%= c.name %>
                                </option>
                                <% }) %>
                        </select>
                    </div>
                    <select name="product_categories" id="categoryHiddenSelect" multiple style="display:none;">
                        <% categories.forEach(c=> { %>
                            <option value="<%= c.id %>" <%=(product.categories || []).includes(c.id) ? 'selected' : ''
                                %>>
                                <%= c.name %>
                            </option>
                            <% }) %>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea name="description" rows="4"><%= product.description %></textarea>
            </div>

            <div class="form-group">
                <label>MDA Certificate Upload</label>
                <div class="upload-zone" id="certUploadZone">
                    <!-- Hide default content if file exists -->
                    <div class="upload-content" style="<%= product.mda_cert ? 'display: none;' : '' %>">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <p class="upload-text">Drag and drop certificate here or <span class="browse-link">browse</span>
                        </p>
                        <p class="upload-hint">PDF, PNG, JPG (Max 5MB)</p>
                    </div>
                    <input type="file" name="mda_cert" id="certInput" accept=".pdf,image/*" style="display: none;">

                    <!-- Show preview if file exists -->
                    <div id="filePreview" class="file-preview"
                        style="<%= product.mda_cert ? 'display: flex;' : 'display: none;' %>">

                        <% let isPdf=product.mda_cert && product.mda_cert.toLowerCase().endsWith('.pdf'); let
                            isImage=product.mda_cert && !isPdf; %>

                            <div id="previewIcon"
                                style="font-size: 3rem; color: var(--blue-medium); margin-bottom: 0.5rem; display: <%= isPdf ? 'block' : 'none' %>;">
                                <i class="fas fa-file-pdf"></i>
                            </div>

                            <img id="previewImg" src="<%= isImage ? product.mda_cert : '' %>" alt="Preview"
                                style="display: <%= isImage ? 'block' : 'none' %>; max-width: 200px; max-height: 200px; object-fit: contain; border: 1px solid var(--gray-200); border-radius: 8px;">

                            <div class="file-info" id="fileInfoChip" style="display: flex;">
                                <span id="fileName" class="file-name">
                                    <%= product.mda_cert ? 'Current Certificate' : '' %>
                                </span>
                                <button type="button" class="remove-file" id="removeCert" title="Remove File">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <!-- Hidden input to track removal if needed by backend API -->
                            <input type="hidden" name="mda_cert_removed" id="mda_cert_removed" value="false">
                            <input type="hidden" name="existing_mda_cert" value="<%= product.mda_cert %>">
                    </div>
                </div>
            </div>

            <h3
                style="margin-top: 2rem; margin-bottom: 1.5rem; font-size: 1.1rem; color: var(--blue-dark); border-bottom: 1px solid var(--gray-200); padding-bottom: 0.5rem;">
                Technical Specifications</h3>

            <div id="specs-container">
                <% if (product.specs && product.specs.length> 0) { %>
                    <% product.specs.forEach(spec=> { %>
                        <div class="grid spec-row"
                            style="grid-template-columns: 1fr 1fr auto; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <input type="text" name="spec_key" value="<%= spec.key %>"
                                    placeholder="Specification Name">
                            </div>
                            <div>
                                <input type="text" name="spec_value" value="<%= spec.value %>" placeholder="Value">
                            </div>
                            <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <% }) %>
                            <% } else { %>
                                <!-- Default empty row if no specs -->
                                <div class="grid spec-row"
                                    style="grid-template-columns: 1fr 1fr auto; gap: 1rem; margin-bottom: 1rem;">
                                    <div>
                                        <input type="text" name="spec_key"
                                            placeholder="Specification Name (e.g. Dimensions)">
                                    </div>
                                    <div>
                                        <input type="text" name="spec_value" placeholder="Value (e.g. 10x10cm)">
                                    </div>
                                    <button type="button" class="btn btn-secondary btn-sm" disabled
                                        style="color: var(--gray-400); border-color: var(--gray-200);">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <% } %>
            </div>

            <button type="button" class="btn btn-secondary btn-sm" onclick="addSpecRow()" style="margin-bottom: 2rem;">
                <i class="fas fa-plus"></i> Add Specification
            </button>

            <div
                style="display: flex; gap: 15px; margin-top: 2rem; border-top: 1px solid var(--gray-100); padding-top: 2rem;">
                <button type="submit" class="btn btn-primary" id="submitBtn" style="flex: 2;">
                    <i class="fas fa-save"></i> <span>Update Product</span>
                </button>
                <a href="/admin/products" class="btn btn-secondary" style="flex: 1;">Cancel</a>
            </div>
        </form>
    </div>
</div>

<style>
    .upload-zone {
        border: 2px dashed var(--gray-300);
        border-radius: 12px;
        padding: 2.5rem 1.5rem;
        text-align: center;
        background: var(--gray-50);
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
    }

    .upload-zone:hover,
    .upload-zone.dragover {
        border-color: var(--blue-medium);
        background: rgba(0, 91, 150, 0.05);
    }

    .upload-icon {
        font-size: 3rem;
        color: var(--gray-400);
        margin-bottom: 1rem;
    }

    .upload-text {
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
    }

    .browse-link {
        color: var(--blue-medium);
        text-decoration: underline;
    }

    .upload-hint {
        font-size: 0.85rem;
        color: var(--gray-500);
    }

    .file-preview {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .file-info {
        display: flex;
        align-items: center;
        gap: 10px;
        background: white;
        padding: 8px 15px;
        border-radius: 20px;
        border: 1px solid var(--gray-200);
        box-shadow: var(--shadow-sm);
        flex-shrink: 0;
        min-width: 0;
    }

    .file-name {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--gray-700);
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .remove-file {
        background: #fff;
        color: var(--danger);
        border: 2px solid #fee2e2;
        width: 36px;
        height: 36px;
        min-width: 36px;
        min-height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .remove-file:hover {
        background: var(--danger);
        color: white;
        border-color: var(--danger);
        transform: scale(1.05);
        box-shadow: 0 3px 6px rgba(220, 38, 38, 0.3);
    }

    .remove-file:active {
        transform: scale(0.95);
    }

    /* Chips Styles */
    .chip-wrapper {
        border: 1px solid var(--gray-300);
        border-radius: 6px;
        padding: 0.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        min-height: 45px;
        background: white;
        align-items: center;
    }

    .chip-wrapper:focus-within {
        border-color: var(--blue-medium);
        box-shadow: 0 0 0 3px rgba(0, 91, 150, 0.1);
    }

    .chip {
        background: var(--blue-lightest);
        color: var(--blue-dark);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
        border: 1px solid var(--blue-light);
    }

    .chip-remove {
        background: none;
        border: none;
        color: var(--blue-medium);
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
    }

    .chip-remove:hover {
        color: var(--danger);
    }

    .chip-wrapper select {
        border: none;
        outline: none;
        padding: 4px;
        flex: 1;
        min-width: 150px;
        font-size: 0.95rem;
        background: transparent;
    }

    /* Mobile Responsive Styles for Buttons */
    @media (max-width: 768px) {
        .remove-file {
            width: 44px;
            height: 44px;
            min-width: 44px;
            min-height: 44px;
            font-size: 1.1rem;
            border-width: 2px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }

        .remove-existing-btn,
        .remove-new-btn {
            width: 44px !important;
            height: 44px !important;
            font-size: 1.1rem !important;
            border-width: 2px !important;
        }

        .star-btn,
        .existing-star-btn,
        .new-star-btn {
            width: 44px !important;
            height: 44px !important;
            font-size: 1.1rem !important;
        }

        .existing-image-card > div[style*="position: absolute; top: 8px"] {
            gap: 8px !important;
        }

        .new-image-card > div[style*="position: absolute; top: 8px"] {
            gap: 8px !important;
        }
    }

    @media (max-width: 480px) {
        .remove-file {
            width: 48px;
            height: 48px;
            min-width: 48px;
            min-height: 48px;
            font-size: 1.2rem;
            border-width: 2.5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .remove-existing-btn,
        .remove-new-btn {
            width: 48px !important;
            height: 48px !important;
            font-size: 1.2rem !important;
        }

        .star-btn,
        .existing-star-btn,
        .new-star-btn {
            width: 48px !important;
            height: 48px !important;
            font-size: 1.2rem !important;
        }

        .file-info {
            padding: 10px 18px;
        }
    }
</style>

<script>
    function setupFileUpload(zoneId, inputId, contentSelector, previewId, removedInputId, hasIcon = true) {
        const zone = document.getElementById(zoneId);
        const input = document.getElementById(inputId);
        const content = zone.querySelector('.upload-content');
        const preview = document.getElementById(previewId);
        const previewImg = preview.querySelector('img');
        const previewIcon = preview.querySelector('#previewIcon');
        const fileName = preview.querySelector('.file-name');
        const removeBtn = preview.querySelector('.remove-file');
        const removedInput = removedInputId ? document.getElementById(removedInputId) : null;

        zone.addEventListener('click', () => input.click());

        zone.addEventListener('dragover', (e) => {
            e.preventDefault();
            zone.classList.add('dragover');
        });

        zone.addEventListener('dragleave', () => {
            zone.classList.remove('dragover');
        });

        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                input.files = e.dataTransfer.files;
                handleFile(input.files[0]);
            }
        });

        input.addEventListener('change', () => {
            if (input.files.length) {
                handleFile(input.files[0]);
            }
        });

        function handleFile(file) {
            content.style.display = 'none';
            preview.style.display = 'flex';
            preview.querySelector('.file-info').style.display = 'flex';
            fileName.textContent = file.name;

            if (removedInput) removedInput.value = 'false';

            if (file.type.startsWith('image/')) {
                if (previewIcon) previewIcon.style.display = 'none';
                previewImg.style.display = 'block';
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                previewImg.style.display = 'none';
                if (previewIcon) previewIcon.style.display = 'block';
            } else {
                // Default
                previewImg.style.display = 'none';
                if (previewIcon) {
                    previewIcon.style.display = 'block';
                    previewIcon.innerHTML = '<i class="fas fa-file"></i>';
                }
            }
        }

        removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            input.value = '';
            content.style.display = 'block';
            preview.style.display = 'none';
            preview.querySelector('.file-info').style.display = 'none';
            if (removedInput) removedInput.value = 'true';
        });
    }

    // Setup for Cert
    setupFileUpload('certUploadZone', 'certInput', '.upload-content', 'filePreview', 'mda_cert_removed', true);

    // Multiple Images Upload Handler for Edit
    let uploadedImages = [];
    let deletedImageIds = [];
    const imageInput = document.getElementById('imageInput');
    const imageUploadZone = document.getElementById('imageUploadZone');
    const imagesPreviewContainer = document.getElementById('imagesPreviewContainer');
    const mainImageIdInput = document.getElementById('mainImageId');
    const deletedImagesInput = document.getElementById('deletedImages');

    // Initialize main image from existing images
    const existingMainImage = document.querySelector('.existing-star-btn.active');
    if (existingMainImage) {
        mainImageIdInput.value = existingMainImage.dataset.imageId;
    }

    imageUploadZone.addEventListener('click', () => imageInput.click());

    imageUploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        imageUploadZone.classList.add('dragover');
    });

    imageUploadZone.addEventListener('dragleave', () => {
        imageUploadZone.classList.remove('dragover');
    });

    imageUploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        imageUploadZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            handleImageFiles(Array.from(e.dataTransfer.files));
        }
    });

    imageInput.addEventListener('change', () => {
        if (imageInput.files.length) {
            handleImageFiles(Array.from(imageInput.files));
        }
    });

    function handleImageFiles(files) {
        const totalImages = document.querySelectorAll('.existing-image-card').length + uploadedImages.length;
        files.forEach(file => {
            if (file.type.startsWith('image/') && totalImages + uploadedImages.length < 10) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = {
                        id: 'new_' + Date.now() + Math.random(),
                        file: file,
                        preview: e.target.result
                    };
                    uploadedImages.push(imageData);
                    updateImagesPreview();
                };
                reader.readAsDataURL(file);
            }
        });
    }

    function updateImagesPreview() {
        const existingCards = document.querySelectorAll('.existing-image-card:not([style*="opacity: 0.5"])');
        const totalImages = existingCards.length + uploadedImages.length;
        
        // Always show upload zone for adding more images
        imageUploadZone.querySelector('.upload-content').style.display = 'block';

        // Add new image previews
        uploadedImages.forEach((img, index) => {
            if (!document.querySelector(`[data-new-id="${img.id}"]`)) {
                const imgCard = document.createElement('div');
                imgCard.className = 'new-image-card';
                imgCard.setAttribute('data-new-id', img.id);
                imgCard.style.cssText = 'position: relative; border: 2px solid var(--gray-200); border-radius: 8px; overflow: hidden; background: var(--gray-50);';
                imgCard.innerHTML = `
                    <img src="${img.preview}" alt="Preview" style="width: 100%; height: 150px; object-fit: cover; display: block;">
                    <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 4px;">
                        <button type="button" class="star-btn new-star-btn" 
                            data-new-id="${img.id}" style="background: rgba(255,255,255,0.9); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <i class="fas fa-star" style="color: #ccc;"></i>
                        </button>
                        <button type="button" class="remove-new-btn" data-new-id="${img.id}" 
                            style="background: rgba(220,38,38,0.9); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                imagesPreviewContainer.appendChild(imgCard);
            }
        });

        // Update star buttons for existing images
        document.querySelectorAll('.existing-star-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const imageId = e.currentTarget.dataset.imageId;
                mainImageIdInput.value = imageId;
                updateStarButtons();
            });
        });

        // Update star buttons for new images
        document.querySelectorAll('.new-star-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                // Clear existing main image selection (new images don't have DB IDs yet)
                mainImageIdInput.value = '';
                // Remove all main labels first
                document.querySelectorAll('.main-label').forEach(label => label.remove());
                // Clear all existing image stars
                document.querySelectorAll('.existing-star-btn').forEach(eb => {
                    eb.classList.remove('active');
                    eb.querySelector('i').style.color = '#ccc';
                    const card = eb.closest('.existing-image-card');
                    if (card) {
                        card.style.borderColor = 'var(--gray-200)';
                    }
                });
                // Clear all new image stars
                document.querySelectorAll('.new-star-btn').forEach(nb => {
                    nb.classList.remove('active');
                    nb.querySelector('i').style.color = '#ccc';
                    const card = nb.closest('.new-image-card');
                    if (card) {
                        card.style.borderColor = 'var(--gray-200)';
                    }
                });
                // Set clicked new image as main
                btn.classList.add('active');
                btn.querySelector('i').style.color = '#FFD700';
                const card = btn.closest('.new-image-card');
                if (card) {
                    card.style.borderColor = 'var(--blue-medium)';
                    const mainLabel = document.createElement('div');
                    mainLabel.className = 'main-label';
                    mainLabel.style.cssText = 'position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,91,150,0.9); color: white; padding: 4px; text-align: center; font-size: 0.75rem; font-weight: 600;';
                    mainLabel.textContent = 'Main Image';
                    card.appendChild(mainLabel);
                }
            });
        });

        // Remove buttons for existing images
        document.querySelectorAll('.remove-existing-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const imageId = e.currentTarget.dataset.imageId;
                const card = e.currentTarget.closest('.existing-image-card');
                card.style.opacity = '0.5';
                card.style.pointerEvents = 'none';
                deletedImageIds.push(imageId);
                deletedImagesInput.value = deletedImageIds.join(',');
                
                // If deleted image was main, clear main image
                if (mainImageIdInput.value === imageId) {
                    mainImageIdInput.value = '';
                }
                updateStarButtons();
            });
        });

        // Remove buttons for new images
        document.querySelectorAll('.remove-new-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const newId = e.currentTarget.dataset.newId;
                uploadedImages = uploadedImages.filter(img => img.id !== newId);
                const card = document.querySelector(`[data-new-id="${newId}"]`);
                if (card) card.remove();
                updateFileInput();
                updateImagesPreview();
            });
        });

        updateStarButtons();
    }

    function updateStarButtons() {
        const mainId = mainImageIdInput.value;
        
        // Remove ALL main labels first (from both existing and new images)
        document.querySelectorAll('.main-label').forEach(label => label.remove());
        
        // Clear all existing image stars and borders
        document.querySelectorAll('.existing-star-btn').forEach(btn => {
            btn.classList.remove('active');
            const icon = btn.querySelector('i');
            icon.style.color = '#ccc';
            const card = btn.closest('.existing-image-card');
            if (card) {
                card.style.borderColor = 'var(--gray-200)';
            }
        });
        
        // Clear all new image stars and borders
        document.querySelectorAll('.new-star-btn').forEach(btn => {
            btn.classList.remove('active');
            const icon = btn.querySelector('i');
            icon.style.color = '#ccc';
            const card = btn.closest('.new-image-card');
            if (card) {
                card.style.borderColor = 'var(--gray-200)';
            }
        });
        
        // Now set the main image if one is selected
        if (mainId) {
            // Update existing image that is main
            document.querySelectorAll('.existing-star-btn').forEach(btn => {
                if (btn.dataset.imageId === mainId) {
                    btn.classList.add('active');
                    const icon = btn.querySelector('i');
                    icon.style.color = '#FFD700';
                    const card = btn.closest('.existing-image-card');
                    if (card) {
                        card.style.borderColor = 'var(--blue-medium)';
                        const mainLabel = document.createElement('div');
                        mainLabel.className = 'main-label';
                        mainLabel.style.cssText = 'position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,91,150,0.9); color: white; padding: 4px; text-align: center; font-size: 0.75rem; font-weight: 600;';
                        mainLabel.textContent = 'Main Image';
                        card.appendChild(mainLabel);
                    }
                }
            });
        }
    }

    function updateFileInput() {
        const dt = new DataTransfer();
        uploadedImages.forEach(img => {
            dt.items.add(img.file);
        });
        imageInput.files = dt.files;
    }

    // Initialize
    updateImagesPreview();

    // Reusable Chips Logic
    function setupChips(wrapperId, selectId, hiddenId) {
        const wrapper = document.getElementById(wrapperId);
        const selectInput = document.getElementById(selectId);
        const hiddenSelect = document.getElementById(hiddenId);

        function updateChips() {
            // Remove existing chips (but keep the select input)
            const chips = wrapper.querySelectorAll('.chip');
            chips.forEach(c => c.remove());

            // Add new chips based on hidden select
            Array.from(hiddenSelect.options).forEach(opt => {
                if (opt.selected) {
                    const chip = document.createElement('div');
                    chip.className = 'chip';
                    chip.innerHTML = `
                        ${opt.text}
                        <button type="button" class="chip-remove" data-value="${opt.value}">
                             <i class="fas fa-times"></i>
                        </button>
                    `;
                    wrapper.insertBefore(chip, selectInput);
                }
            });

            // Update chip remove listeners
            wrapper.querySelectorAll('.chip-remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const val = e.currentTarget.dataset.value;
                    const opt = hiddenSelect.querySelector(`option[value="${val}"]`);
                    if (opt) opt.selected = false;
                    updateChips();
                });
            });

            // Hide selected options in dropdown
            Array.from(hiddenSelect.options).forEach(opt => {
                const inputOpt = selectInput.querySelector(`option[value="${opt.value}"]`);
                if (inputOpt) {
                    if (opt.selected) {
                        inputOpt.setAttribute('disabled', 'disabled');
                        inputOpt.style.display = 'none';
                    } else {
                        inputOpt.removeAttribute('disabled');
                        inputOpt.style.display = 'block';
                    }
                }
            });

            selectInput.value = "";
        }

        selectInput.addEventListener('change', () => {
            const val = selectInput.value;
            if (val) {
                const opt = hiddenSelect.querySelector(`option[value="${val}"]`);
                if (opt) opt.selected = true;
                updateChips();
            }
        });

        // Initial build
        updateChips();
    }

    // Initialize Chips
    setupChips('typeChipWrapper', 'typeSelectInput', 'typeHiddenSelect');
    setupChips('categoryChipWrapper', 'categorySelectInput', 'categoryHiddenSelect');


    // Specifications Logic
    function addSpecRow() {
        const container = document.getElementById('specs-container');
        const div = document.createElement('div');
        div.className = 'grid spec-row';
        div.style.gridTemplateColumns = '1fr 1fr auto';
        div.style.gap = '1rem';
        div.style.marginBottom = '1rem';
        div.innerHTML = `
            <div>
                <input type="text" name="spec_key" placeholder="Specification Name" class="form-control">
            </div>
            <div>
                <input type="text" name="spec_value" placeholder="Value" class="form-control">
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        `;
        container.appendChild(div);
    }

    document.getElementById('editProductForm').addEventListener('submit', function () {
        const btn = document.getElementById('submitBtn');
        btn.classList.add('btn-loading');
        btn.disabled = true;
        btn.querySelector('span').textContent = 'Updating...';
    });
</script>