<div class="companies-page">
    <div class="card-header companies-header">
        <h1>Edit Product: <%= product.model %>
        </h1>
        <a href="/admin/products" class="btn btn-secondary btn-sm" title="Go Back">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>

    <div class="card" style="max-width: 900px; margin: 0 auto;">
        <form id="editProductForm" action="/admin/products/edit/<%= product.id %>" method="POST"
            enctype="multipart/form-data">

            <h3
                style="margin-bottom: 1.5rem; font-size: 1.1rem; color: var(--blue-dark); border-bottom: 1px solid var(--gray-200); padding-bottom: 0.5rem;">
                Basic Information</h3>

            <div class="form-group" style="margin-bottom: 2rem;">
                <label>Product Images <span
                        style="color: var(--gray-500); font-size: 0.85rem; font-weight: normal;">(Select main image with
                        star)</span></label>
                <div class="upload-zone" id="imageUploadZone">
                    <div class="upload-content">
                        <i class="fas fa-images upload-icon"></i>
                        <p class="upload-text">Drag and drop product images here or <span
                                class="browse-link">browse</span></p>
                        <p class="upload-hint">PNG, JPG, WEBP (Max 5MB each, up to 10 images)</p>
                    </div>
                    <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">

                    <div id="imageUploadProgress" class="upload-progress-container"
                        style="display: none; margin-top: 10px;">
                        <div class="upload-progress-bar"></div>
                        <span class="upload-status-text"></span>
                    </div>
                </div>
                <div id="imagesPreviewContainer"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    <% if (product.images && product.images.length> 0) { %>
                        <% product.images.forEach((img, index)=> { %>
                            <div class="existing-image-card" data-image-id="<%= img.id %>"
                                style="position: relative; border: 2px solid <%= img.is_main ? 'var(--blue-medium)' : 'var(--gray-200)' %>; border-radius: 8px; overflow: hidden; background: var(--gray-50);">
                                <img src="<%= img.image_path %>" alt="Product Image"
                                    style="width: 100%; height: 150px; object-fit: cover; display: block;">
                                <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 4px;">
                                    <button type="button"
                                        class="star-btn existing-star-btn <%= img.is_main ? 'active' : '' %>"
                                        data-image-id="<%= img.id %>"
                                        style="background: rgba(255,255,255,0.9); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <i class="fas fa-star"
                                            style="color: <%= img.is_main ? '#FFD700' : '#ccc' %>;"></i>
                                    </button>
                                    <button type="button" class="remove-existing-btn" data-image-id="<%= img.id %>"
                                        style="background: rgba(220,38,38,0.9); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <% if (img.is_main) { %>
                                    <div class="main-label"
                                        style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,91,150,0.9); color: white; padding: 4px; text-align: center; font-size: 0.75rem; font-weight: 600;">
                                        Main Image</div>
                                    <% } %>
                                        <input type="hidden" name="existing_images[]" value="<%= img.id %>">
                            </div>
                            <% }) %>
                                <% } %>
                </div>
                <input type="hidden" name="main_image_id" id="mainImageId"
                    value="<%= product.images && product.images.find(img => img.is_main) ? product.images.find(img => img.is_main).id : '' %>">
                <input type="hidden" name="deleted_images" id="deletedImages" value="">
                <div id="imageHiddenInputs"></div>
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label>Product Code <span style="color: var(--danger);">*</span></label>
                    <input type="text" name="code" value="<%= product.code %>" required>
                </div>
                <div class="form-group">
                    <label>Product Model</label>
                    <input type="text" name="model" value="<%= product.model %>">
                </div>
                <div class="form-group">
                    <label>Product MDA Reg. No.</label>
                    <input type="text" name="mda_reg_no" value="<%= product.mda_reg_no %>">
                </div>
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label>Supplier</label>
                    <select name="supplier_id">
                        <option value="">Select Supplier...</option>
                        <% if (suppliers && suppliers.length> 0) { %>
                            <% suppliers.forEach(supplier=> { %>
                                <option value="<%= supplier.id %>" <%=product.supplier_id==supplier.id ? 'selected' : ''
                                    %>>
                                    <%= supplier.name %>
                                        <% if (supplier.country_name) { %> - <%= supplier.country_name %>
                                                <% } %>
                                </option>
                                <% }) %>
                                    <% } %>
                    </select>
                </div>
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label>Product Types</label>
                    <div class="chip-wrapper" id="typeChipWrapper">
                        <select id="typeSelectInput">
                            <option value="">Add Type...</option>
                            <% types.forEach(t=> { %>
                                <option value="<%= t.id %>">
                                    <%= t.value %>
                                </option>
                                <% }) %>
                        </select>
                    </div>
                    <select name="product_types" id="typeHiddenSelect" multiple style="display:none;">
                        <% types.forEach(t=> { %>
                            <option value="<%= t.id %>" <%=(product.product_types || []).includes(t.id) ? 'selected'
                                : '' %>><%= t.value %>
                            </option>
                            <% }) %>
                    </select>
                </div>
                <div class="form-group">
                    <label>Categories</label>
                    <div class="chip-wrapper" id="categoryChipWrapper">
                        <select id="categorySelectInput">
                            <option value="">Add Category...</option>
                            <% categories.forEach(c=> { %>
                                <option value="<%= c.id %>">
                                    <%= c.name %>
                                </option>
                                <% }) %>
                        </select>
                    </div>
                    <select name="product_categories" id="categoryHiddenSelect" multiple style="display:none;">
                        <% categories.forEach(c=> { %>
                            <option value="<%= c.id %>" <%=(product.categories || []).includes(c.id) ? 'selected' : ''
                                %>><%= c.name %>
                            </option>
                            <% }) %>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea name="description" rows="4"><%= product.description %></textarea>
            </div>

            <div class="form-group">
                <label>MDA Certificate Upload</label>
                <div class="upload-zone" id="certUploadZone">
                    <div class="upload-content" style="<%= product.mda_cert ? 'display: none;' : '' %>">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <p class="upload-text">Drag and drop certificate here or <span class="browse-link">browse</span>
                        </p>
                        <p class="upload-hint">PDF, PNG, JPG (Max 5MB)</p>
                    </div>
                    <input type="file" id="certInput" accept=".pdf,image/*" style="display: none;">
                    <input type="hidden" name="mda_cert_path" id="certPathInput">
                    <input type="hidden" name="mda_cert_removed" id="mda_cert_removed" value="false">
                    <input type="hidden" name="existing_mda_cert" value="<%= product.mda_cert %>">

                    <div id="certUploadProgress" class="upload-progress-container"
                        style="display: none; margin-top: 10px;">
                        <div class="upload-progress-bar"></div>
                        <span class="upload-status-text"></span>
                    </div>

                    <div id="filePreview" class="file-preview"
                        style="<%= product.mda_cert ? 'display: flex;' : 'display: none;' %>">
                        <% let isPdf=product.mda_cert && product.mda_cert.toLowerCase().endsWith('.pdf'); %>
                            <% let isImage=product.mda_cert && !isPdf; %>
                                <div id="previewIcon"
                                    style="font-size: 3rem; color: var(--blue-medium); margin-bottom: 0.5rem; display: <%= isPdf ? 'block' : 'none' %>;">
                                    <i class="fas fa-file-pdf"></i>
                                </div>
                                <img id="previewImg" src="<%= isImage ? product.mda_cert : '' %>" alt="Preview"
                                    style="display: <%= isImage ? 'block' : 'none' %>; max-width: 200px; max-height: 200px; object-fit: contain; border: 1px solid var(--gray-200); border-radius: 8px;">

                                <div class="file-info" id="fileInfoChip" style="display: flex;">
                                    <span id="fileName" class="file-name">
                                        <%= product.mda_cert ? 'Current Certificate' : '' %>
                                    </span>
                                    <button type="button" class="remove-file" id="removeCert" title="Remove File">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                    </div>
                </div>
            </div>

            <h3
                style="margin-top: 2rem; margin-bottom: 1.5rem; font-size: 1.1rem; color: var(--blue-dark); border-bottom: 1px solid var(--gray-200); padding-bottom: 0.5rem;">
                Technical Specifications</h3>

            <div id="specs-container">
                <% if (product.specs && product.specs.length> 0) { %>
                    <% product.specs.forEach(spec=> { %>
                        <div class="grid spec-row"
                            style="grid-template-columns: 1fr 1fr auto; gap: 1rem; margin-bottom: 1rem;">
                            <div><input type="text" name="spec_key" value="<%= spec.key %>"></div>
                            <div><input type="text" name="spec_value" value="<%= spec.value %>"></div>
                            <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()"><i
                                    class="fas fa-trash"></i></button>
                        </div>
                        <% }) %>
                            <% } else { %>
                                <div class="grid spec-row"
                                    style="grid-template-columns: 1fr 1fr auto; gap: 1rem; margin-bottom: 1rem;">
                                    <div><input type="text" name="spec_key"
                                            placeholder="Specification Name (e.g. Dimensions)"></div>
                                    <div><input type="text" name="spec_value" placeholder="Value (e.g. 10x10cm)"></div>
                                    <button type="button" class="btn btn-secondary btn-sm" disabled><i
                                            class="fas fa-trash"></i></button>
                                </div>
                                <% } %>
            </div>

            <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 2rem;">
                <button type="button" class="btn btn-secondary btn-sm" onclick="addSpecRow()">
                    <i class="fas fa-plus"></i> Add Specification
                </button>
                <div style="height: 20px; width: 1px; background: var(--gray-200);"></div>
                <button type="button" class="btn btn-outline btn-sm"
                    onclick="document.getElementById('specExcelInput').click()"
                    style="color: var(--blue-medium); border-color: var(--blue-medium);">
                    <i class="fas fa-file-excel"></i> Import Specs from Excel
                </button>
                <input type="file" id="specExcelInput" accept=".xlsx, .xls, .csv" style="display: none;"
                    onchange="handleSpecExcel(this)">
                <a href="<%= templates.specs %>" target="_blank"
                    style="font-size: 0.8rem; color: var(--gray-500); text-decoration: underline;">
                    Download Template
                </a>
            </div>

            <div
                style="display: flex; gap: 15px; margin-top: 2rem; border-top: 1px solid var(--gray-100); padding-top: 2rem;">
                <button type="submit" class="btn btn-primary" id="submitBtn" style="flex: 2;">
                    <i class="fas fa-save"></i> <span>Update Product</span>
                </button>
                <a href="/admin/products" class="btn btn-secondary" style="flex: 1;">Cancel</a>
            </div>
        </form>
    </div>
</div>

<style>
    .upload-zone {
        border: 2px dashed var(--gray-300);
        border-radius: 12px;
        padding: 2.5rem 1.5rem;
        text-align: center;
        background: var(--gray-50);
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
    }

    .upload-zone:hover,
    .upload-zone.dragover {
        border-color: var(--blue-medium);
        background: rgba(0, 91, 150, 0.05);
    }

    .upload-icon {
        font-size: 3rem;
        color: var(--gray-400);
        margin-bottom: 1rem;
    }

    .upload-text {
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
    }

    .browse-link {
        color: var(--blue-medium);
        text-decoration: underline;
    }

    .upload-hint {
        font-size: 0.85rem;
        color: var(--gray-500);
    }

    .file-preview {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .file-info {
        display: flex;
        align-items: center;
        gap: 10px;
        background: white;
        padding: 8px 15px;
        border-radius: 20px;
        border: 1px solid var(--gray-200);
        box-shadow: var(--shadow-sm);
        flex-shrink: 0;
        min-width: 0;
    }

    .file-name {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--gray-700);
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .remove-file {
        background: #fff;
        color: var(--danger);
        border: 2px solid #fee2e2;
        width: 36px;
        height: 36px;
        min-width: 36px;
        min-height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .remove-file:hover {
        background: var(--danger);
        color: white;
        border-color: var(--danger);
        transform: scale(1.05);
        box-shadow: 0 3px 6px rgba(220, 38, 38, 0.3);
    }

    .upload-progress-container {
        width: 100%;
        background-color: var(--gray-200);
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .upload-progress-bar {
        height: 100%;
        width: 0%;
        background-color: var(--blue-medium);
        border-radius: 8px;
        text-align: center;
        color: white;
        transition: width 0.3s ease-in-out;
        position: absolute;
        left: 0;
        top: 0;
    }

    .upload-status-text {
        position: relative;
        z-index: 1;
        color: var(--gray-700);
        font-size: 0.85rem;
        font-weight: 600;
    }

    /* Chips Styles */
    .chip-wrapper {
        border: 1px solid var(--gray-300);
        border-radius: 6px;
        padding: 0.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        min-height: 45px;
        background: white;
        align-items: center;
    }

    .chip-wrapper:focus-within {
        border-color: var(--blue-medium);
        box-shadow: 0 0 0 3px rgba(0, 91, 150, 0.1);
    }

    .chip {
        background: var(--blue-lightest);
        color: var(--blue-dark);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
        border: 1px solid var(--blue-light);
    }

    .chip-remove {
        background: none;
        border: none;
        color: var(--blue-medium);
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
    }

    .chip-remove:hover {
        color: var(--danger);
    }

    .chip-wrapper select {
        border: none;
        outline: none;
        padding: 4px;
        flex: 1;
        min-width: 150px;
        font-size: 0.95rem;
        background: transparent;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
    async function uploadFileInChunks(file, type, progressContainerId) {
        const chunkSize = 750 * 1024; // 750KB
        const totalChunks = Math.ceil(file.size / chunkSize);
        const fileId = Date.now() + '-' + Math.round(Math.random() * 1e9);

        const container = document.getElementById(progressContainerId);
        const progressBar = container.querySelector('.upload-progress-bar');
        const statusText = container.querySelector('.upload-status-text');

        container.style.display = 'flex';

        for (let i = 0; i < totalChunks; i++) {
            const start = i * chunkSize;
            const end = Math.min(start + chunkSize, file.size);
            const chunk = file.slice(start, end);

            const formData = new FormData();
            formData.append('chunk', chunk);
            formData.append('chunkIndex', i);
            formData.append('totalChunks', totalChunks);
            formData.append('fileId', fileId);
            formData.append('fileName', file.name);
            formData.append('type', type);

            const response = await fetch('/admin/products/upload-chunk', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'Upload failed');

            const percent = Math.round(((i + 1) / totalChunks) * 100);
            progressBar.style.width = percent + '%';
            statusText.textContent = `Uploading: ${percent}%`;

            if (result.filePath) {
                return result.filePath;
            }
        }
    }

    function setupFileUpload(zoneId, inputId, contentSelector, previewId, removedInputId, hasIcon = true) {
        const zone = document.getElementById(zoneId);
        const input = document.getElementById(inputId);
        const content = zone.querySelector('.upload-content');
        const preview = document.getElementById(previewId);
        const previewImg = preview.querySelector('img');
        const previewIcon = preview.querySelector('#previewIcon');
        const fileName = preview.querySelector('.file-name');
        const removeBtn = preview.querySelector('.remove-file');
        const removedInput = removedInputId ? document.getElementById(removedInputId) : null;

        zone.addEventListener('click', () => input.click());

        zone.addEventListener('dragover', (e) => {
            e.preventDefault();
            zone.classList.add('dragover');
        });

        zone.addEventListener('dragleave', () => {
            zone.classList.remove('dragover');
        });

        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                input.files = e.dataTransfer.files;
                handleFile(input.files[0]);
            }
        });

        input.addEventListener('change', () => {
            if (input.files.length) {
                handleFile(input.files[0]);
            }
        });

        function handleFile(file) {
            if (file.size > 5 * 1024 * 1024) {
                alert('File too large. Max 5MB.');
                input.value = '';
                return;
            }

            content.style.display = 'none';
            preview.style.display = 'flex';
            preview.querySelector('.file-info').style.display = 'flex';
            fileName.textContent = file.name;
            document.getElementById('certPathInput').value = '';
            if (removedInput) removedInput.value = 'false';

            if (file.type.startsWith('image/')) {
                if (previewIcon) previewIcon.style.display = 'none';
                previewImg.style.display = 'block';
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                previewImg.style.display = 'none';
                if (previewIcon) previewIcon.style.display = 'block';
            } else {
                previewImg.style.display = 'none';
                if (previewIcon) {
                    previewIcon.style.display = 'block';
                    previewIcon.innerHTML = '<i class="fas fa-file"></i>';
                }
            }
        }

        removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            input.value = '';
            document.getElementById('certPathInput').value = '';
            content.style.display = 'block';
            preview.style.display = 'none';
            preview.querySelector('.file-info').style.display = 'none';
            if (removedInput) removedInput.value = 'true';
            document.getElementById('certUploadProgress').style.display = 'none';
        });
    }

    setupFileUpload('certUploadZone', 'certInput', '.upload-content', 'filePreview', 'mda_cert_removed', true);

    let uploadedImages = [];
    let deletedImageIds = [];
    const imageInput = document.getElementById('imageInput');
    const imageUploadZone = document.getElementById('imageUploadZone');
    const imagesPreviewContainer = document.getElementById('imagesPreviewContainer');
    const mainImageIdInput = document.getElementById('mainImageId');
    const deletedImagesInput = document.getElementById('deletedImages');

    imageUploadZone.addEventListener('click', () => imageInput.click());

    imageUploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        imageUploadZone.classList.add('dragover');
    });

    imageUploadZone.addEventListener('dragleave', () => {
        imageUploadZone.classList.remove('dragover');
    });

    imageUploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        imageUploadZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            handleImageFiles(Array.from(e.dataTransfer.files));
        }
    });

    imageInput.addEventListener('change', () => {
        if (imageInput.files.length) {
            handleImageFiles(Array.from(imageInput.files));
        }
    });

    function handleImageFiles(files) {
        const totalImages = document.querySelectorAll('.existing-image-card:not([style*="opacity"])').length + uploadedImages.length;
        files.forEach(file => {
            if (file.size > 5 * 1024 * 1024) {
                alert(`File ${file.name} is too large. Max 5MB.`);
                return;
            }
            if (file.type.startsWith('image/') && (totalImages + uploadedImages.length) < 10) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = {
                        id: 'new_' + Date.now() + Math.random(),
                        file: file,
                        preview: e.target.result
                    };
                    uploadedImages.push(imageData);
                    updateImagesPreview();
                };
                reader.readAsDataURL(file);
            }
        });
    }

    function updateImagesPreview() {
        document.querySelectorAll('.new-image-card').forEach(c => c.remove());

        uploadedImages.forEach((img, index) => {
            const imgCard = document.createElement('div');
            imgCard.className = 'new-image-card';
            imgCard.setAttribute('data-new-id', img.id);
            imgCard.style.cssText = 'position: relative; border: 2px solid var(--gray-200); border-radius: 8px; overflow: hidden; background: var(--gray-50);';
            imgCard.innerHTML = `
                <img src="${img.preview}" alt="Preview" style="width: 100%; height: 150px; object-fit: cover; display: block;">
                <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 4px;">
                    <button type="button" class="star-btn new-star-btn" 
                        data-new-id="${img.id}" style="background: rgba(255,255,255,0.9); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <i class="fas fa-star" style="color: #ccc;"></i>
                    </button>
                    <button type="button" class="remove-new-btn" data-new-id="${img.id}" 
                        style="background: rgba(220,38,38,0.9); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            imagesPreviewContainer.appendChild(imgCard);
        });

        attachImageEvents();
    }

    function attachImageEvents() {
        document.querySelectorAll('.existing-star-btn').forEach(btn => {
            btn.onclick = (e) => {
                const imageId = btn.dataset.imageId;
                mainImageIdInput.value = imageId;
                updateStarButtons();
            };
        });

        document.querySelectorAll('.new-star-btn').forEach(btn => {
            btn.onclick = (e) => {
                mainImageIdInput.value = '';
                document.querySelectorAll('.star-btn').forEach(b => {
                    b.classList.remove('active');
                    b.querySelector('i').style.color = '#ccc';
                    b.closest('.new-image-card, .existing-image-card').style.borderColor = 'var(--gray-200)';
                });
                document.querySelectorAll('.main-label').forEach(l => l.remove());

                btn.classList.add('active');
                btn.querySelector('i').style.color = '#FFD700';
                const card = btn.closest('.new-image-card');
                card.style.borderColor = 'var(--blue-medium)';
                const label = document.createElement('div');
                label.className = 'main-label';
                label.style.cssText = 'position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,91,150,0.9); color: white; padding: 4px; text-align: center; font-size: 0.75rem; font-weight: 600;';
                label.textContent = 'Main Image';
                card.appendChild(label);
            };
        });

        document.querySelectorAll('.remove-existing-btn').forEach(btn => {
            btn.onclick = (e) => {
                const id = btn.dataset.imageId;
                const card = btn.closest('.existing-image-card');
                card.style.opacity = '0.5';
                card.style.pointerEvents = 'none';
                deletedImageIds.push(id);
                deletedImagesInput.value = deletedImageIds.join(',');
                if (mainImageIdInput.value === id) mainImageIdInput.value = '';
                updateStarButtons();
            };
        });

        document.querySelectorAll('.remove-new-btn').forEach(btn => {
            btn.onclick = (e) => {
                const id = btn.dataset.newId;
                uploadedImages = uploadedImages.filter(img => img.id !== id);
                updateImagesPreview();
            };
        });
    }

    function updateStarButtons() {
        const mainId = mainImageIdInput.value;
        document.querySelectorAll('.main-label').forEach(l => l.remove());
        document.querySelectorAll('.star-btn').forEach(btn => {
            const isMain = btn.dataset.imageId === mainId;
            btn.classList.toggle('active', isMain);
            btn.querySelector('i').style.color = isMain ? '#FFD700' : '#ccc';
            const card = btn.closest('.existing-image-card, .new-image-card');
            card.style.borderColor = isMain ? 'var(--blue-medium)' : 'var(--gray-200)';
            if (isMain) {
                const label = document.createElement('div');
                label.className = 'main-label';
                label.style.cssText = 'position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,91,150,0.9); color: white; padding: 4px; text-align: center; font-size: 0.75rem; font-weight: 600;';
                label.textContent = 'Main Image';
                card.appendChild(label);
            }
        });
    }

    function setupChips(wrapperId, selectId, hiddenId) {
        const wrapper = document.getElementById(wrapperId);
        const selectInput = document.getElementById(selectId);
        const hiddenSelect = document.getElementById(hiddenId);

        function updateChips() {
            wrapper.querySelectorAll('.chip').forEach(c => c.remove());
            Array.from(hiddenSelect.options).forEach(opt => {
                if (opt.selected) {
                    const chip = document.createElement('div');
                    chip.className = 'chip';
                    chip.innerHTML = `${opt.text} <button type="button" class="chip-remove" data-value="${opt.value}"><i class="fas fa-times"></i></button>`;
                    wrapper.insertBefore(chip, selectInput);
                }
            });
            wrapper.querySelectorAll('.chip-remove').forEach(btn => {
                btn.onclick = () => {
                    const val = btn.dataset.value;
                    const opt = hiddenSelect.querySelector(`option[value="${val}"]`);
                    if (opt) opt.selected = false;
                    updateChips();
                };
            });
            Array.from(hiddenSelect.options).forEach(opt => {
                const inputOpt = selectInput.querySelector(`option[value="${opt.value}"]`);
                if (inputOpt) {
                    inputOpt.disabled = opt.selected;
                    inputOpt.style.display = opt.selected ? 'none' : 'block';
                }
            });
            selectInput.value = "";
        }
        selectInput.onchange = () => {
            const opt = hiddenSelect.querySelector(`option[value="${selectInput.value}"]`);
            if (opt) opt.selected = true;
            updateChips();
        };
        updateChips();
    }

    setupChips('typeChipWrapper', 'typeSelectInput', 'typeHiddenSelect');
    setupChips('categoryChipWrapper', 'categorySelectInput', 'categoryHiddenSelect');

    function addSpecRow(key = '', value = '') {
        const container = document.getElementById('specs-container');
        const div = document.createElement('div');
        div.className = 'grid spec-row';
        div.style.gridTemplateColumns = '1fr 1fr auto';
        div.style.gap = '1rem';
        div.style.marginBottom = '1rem';
        div.innerHTML = `
            <div><input type="text" name="spec_key" placeholder="Specification Name" value="${key}"></div>
            <div><input type="text" name="spec_value" placeholder="Value" value="${value}"></div>
            <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        `;
        container.appendChild(div);
    }

    function handleSpecExcel(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        const reader = new FileReader();

        reader.onload = function (e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                const dataRows = rows.slice(1);

                if (dataRows.length === 0) {
                    alert('No data found in the Excel file.');
                    return;
                }

                const container = document.getElementById('specs-container');
                const existingRows = container.querySelectorAll('.spec-row');
                if (existingRows.length === 1) {
                    const firstKey = existingRows[0].querySelector('input[name="spec_key"]').value;
                    const firstVal = existingRows[0].querySelector('input[name="spec_value"]').value;
                    if (!firstKey && !firstVal) {
                        existingRows[0].remove();
                    }
                }

                dataRows.forEach(row => {
                    const key = row[0] ? row[0].toString().trim() : '';
                    const val = row[1] ? row[1].toString().trim() : '';
                    if (key || val) {
                        addSpecRow(key, val);
                    }
                });

                input.value = '';
            } catch (err) {
                console.error(err);
                alert('Failed to parse Excel file. Please ensure it follows the template.');
            }
        };

        reader.readAsArrayBuffer(file);
    }

    document.getElementById('editProductForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.classList.add('btn-loading');
        btn.disabled = true;
        btn.querySelector('span').textContent = 'Processing Files...';

        try {
            const certInput = document.getElementById('certInput');
            const certPathInput = document.getElementById('certPathInput');
            if (certInput.files.length > 0 && !certPathInput.value) {
                certPathInput.value = await uploadFileInChunks(certInput.files[0], 'cert', 'certUploadProgress');
            }

            const hiddenInputsContainer = document.getElementById('imageHiddenInputs');
            hiddenInputsContainer.innerHTML = '';
            for (let i = 0; i < uploadedImages.length; i++) {
                const img = uploadedImages[i];
                btn.querySelector('span').textContent = `Uploading Image ${i + 1}/${uploadedImages.length}...`;
                const serverPath = await uploadFileInChunks(img.file, 'product', 'imageUploadProgress');
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'product_images_paths';
                hiddenInput.value = serverPath;
                hiddenInputsContainer.appendChild(hiddenInput);
            }

            btn.querySelector('span').textContent = 'Updating...';
            this.submit();
        } catch (error) {
            console.error(error);
            alert('Upload failed: ' + error.message);
            btn.classList.remove('btn-loading');
            btn.disabled = false;
            btn.querySelector('span').textContent = 'Update Product';
        }
    });

    attachImageEvents();
</script>